# 9. API ì˜ˆì™¸ ì²˜ë¦¬

- API ì˜ˆì™¸ ì²˜ë¦¬ - ì‹œì‘
- API ì˜ˆì™¸ ì²˜ë¦¬ - ìŠ¤í”„ë§ ë¶€íŠ¸ ê¸°ë³¸ ì˜¤ë¥˜ ì²˜ë¦¬
- API ì˜ˆì™¸ ì²˜ë¦¬ - HandlerExceptionResolver ì‹œì‘
- API ì˜ˆì™¸ ì²˜ë¦¬ - HandlerExceptionResolver í™œìš©
- API ì˜ˆì™¸ ì²˜ë¦¬ - ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ExceptionResolver1
- API ì˜ˆì™¸ ì²˜ë¦¬ - ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ExceptionResolver2
- API ì˜ˆì™¸ ì²˜ë¦¬ - @ExceptionHandler
- API ì˜ˆì™¸ ì²˜ë¦¬ - @ControllerAdvice

## API ì˜ˆì™¸ ì²˜ë¦¬ - ì‹œì‘

**ëª©í‘œ**

API ì˜ˆì™¸ ì²˜ë¦¬ëŠ” ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œ?

APIì˜ ê²½ìš° ì–´ë–»ê²Œ ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ í•˜ë©´ ì¢‹ì€ì§€ ì•Œì•„ë³´ì

APIë„ ì˜¤ë¥˜í˜ì´ì§€ì—ì„œ í–ˆë˜ ê²ƒ ì²˜ëŸ¼ ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ì„œ ì„œë¸”ë¦¿ ì˜¤ë¥˜ í˜ì´ì§€ ë°©ì‹ì„ ì‚¬ìš©í•´ë³´ì.

**ApiExceptionController**

```java
@Slf4j
@RestController
public class ApiExceptionController {
    @GetMapping("/api/members/{id}")
    public MemberDto getMember(@PathVariable("id") String id) {
        if (id.equals("ex")) {
            throw new RuntimeException("ì˜ëª»ëœ ì‚¬ìš©ì");
        }
        return new MemberDto(id, "hello " + id);
    }

    @Data
    @AllArgsConstructor
    static class MemberDto{
        private String memberId;
        private String name;
    }
}

```

[http://localhost:8080/api/members/spring](http://localhost:8080/api/members/spring) â†’ postman ìœ¼ë¡œ í˜¸ì¶œ ì‹œ 

```java
{
    "memberId": "spring",
    "name": "hello spring"
}
```

ë°˜í™˜ ëœë‹¤.

[http://localhost:8080/api/members/ex](http://localhost:8080/api/members/ex) â†’ postman ìœ¼ë¡œ í˜¸ì¶œ ì‹œ

```java
<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
</head>

<body>
    <div class="container" style="max-width: 600px">
        <div class="py-5 text-center">
            <h2>500 ì˜¤ë¥˜ í™”ë©´</h2>
        </div>
        <div>
            <p>ì˜¤ë¥˜ í™”ë©´ ì…ë‹ˆë‹¤.</p>
        </div>
        <hr class="my-4">
    </div> <!-- /container -->
</body>

</html>
```

ë°˜í™˜ ëœë‹¤.

ì´ ë°˜í™˜ ê°’ì€ ì´ì „ ì˜¤ë¥˜í˜ì´ì§€ì—ì„œ ë§Œë“¤ì—ˆë˜ ì˜¤ë¥˜ í™”ë©´ì´ë‹¤. í•˜ì§€ë§Œ API ë°©ì‹ì˜ í†µì‹ ì—ì„œ ì˜¤ë¥˜ì— ëŒ€í•œ ë°˜í™˜ë„ JSON typeìœ¼ë¡œ ë°›ê³ ì‹¶ë‹¤.

**ErrorPageController**

```java
@RequestMapping(value = "/error-page/500", produces =
          MediaType.APPLICATION_JSON_VALUE)
public ResponseEntity<Map<String, Object>> errorPage500Api(HttpServletRequest
                                                                   request, HttpServletResponse response) {
    log.info("API errorPage 500");
    Map<String, Object> result = new HashMap<>();
    Exception ex = (Exception) request.getAttribute(ERROR_EXCEPTION);
    result.put("status", request.getAttribute(ERROR_STATUS_CODE));
    result.put("message", ex.getMessage());
    Integer statusCode = (Integer)
            request.getAttribute(RequestDispatcher.ERROR_STATUS_CODE);
    return new ResponseEntity(result, HttpStatus.valueOf(statusCode));
}
```

- ë‹¤ì‹œ [http://localhost:8080/api/members/ex](http://localhost:8080/api/members/ex) postman ìœ¼ë¡œ ì „ì†¡í•˜ì.
- **ë°˜í™˜ ê²°ê³¼**

```java
{
    "message": "ì˜ëª»ëœ ì‚¬ìš©ì",
    "status": 500
}
```

![image.png](9%20API%20%E1%84%8B%E1%85%A8%E1%84%8B%E1%85%AC%20%E1%84%8E%E1%85%A5%E1%84%85%E1%85%B5%2011d29d746aff80a0ad98cd4ea759a997/image.png)

- Accept - application/json ì´ê¸°ë•Œë¬¸ì—, RuntimeException ë°œìƒ í›„ WebServerCustomizer ì—ì„œ ë“±ë¡ëœ `ErrorPage errorPageEx = new ErrorPage*(*RuntimeException.class, "/error-page/500"*)*;` ì—ì„œ `â€œ/error-page/500â€` ì„ í˜¸ì¶œí•œë‹¤.
- ê·¸ëŸ¬ë©´ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ
    - `@RequestMapping*(*"/error-page/500"*)*public String errorPage500*(*HttpServletRequest request, HttpServletResponse response*)*`
    - `@RequestMapping*(*value = "/error-page/500", produces =        MediaType.*APPLICATION_JSON_VALUE)*public ResponseEntity*<*Map*<*String, Object*>>* errorPage500Api*(*HttpServletRequest                                                                   request, HttpServletResponse response*)*`
    
    â†’ ë‘˜ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì•¼ í•œë‹¤. ì´ë•Œ ìš”ì²­ Headersì˜ Accept ê°’ì´ MediaType.APPLICATION_JSON_VALUE ì™€ ì¼ì¹˜í•˜ê¸°ì—, `errorPage500Api` ê°€ í˜¸ì¶œëœë‹¤.
    

## API ì˜ˆì™¸ ì²˜ë¦¬ - ìŠ¤í”„ë§ ë¶€íŠ¸ ê¸°ë³¸ ì˜¤ë¥˜ ì²˜ë¦¬

Servletì„ ì‚¬ìš©í•œ ìš”ë¥˜ì²˜ë¦¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê¸°ìœ„í•´ WebServerCustomizer ì˜ `@Component` ë¥¼ ì£¼ì„ì²˜ë¦¬ í•¨.

**ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ê¸°ë³¸ ì œê³µí•˜ëŠ” BasicErrorController ë¥¼ ì‚¬ìš©í•  ê²ƒì´ë‹¤.**

**BasicErrorController**

```java
@RequestMapping(produces = MediaType.TEXT_HTML_VALUE)
 public ModelAndView errorHtml(HttpServletRequest request, HttpServletResponse
 response) {}
 @RequestMapping
 public ResponseEntity<Map<String, Object>> error(HttpServletRequest request) {}
```

[http://localhost:8080/api/members/ex](http://localhost:8080/api/members/ex) â†’ postman ìš”ì²­

ì‹¤í–‰ ê²°ê³¼

```java
{
    "timestamp": "2024-11-01T09:06:03.058+00:00",
    "status": 500,
    "error": "Internal Server Error",
    "path": "/api/members/ex"
}
```

**ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ì˜ˆì™¸ ì²˜ë¦¬**

- ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ê¸°ë³¸ ì„¤ì •ì€ ì˜¤ë¥˜ ë°œìƒ ì‹œ /error ë¥¼ ì˜¤ë¥˜ í˜ì´ì§€ë¡œ ìš”ì²­í•œë‹¤.

### Html í˜ì´ì§€ vs API ì˜¤ë¥˜

`BasicErrorController` ë¥¼ í™•ì¥í•˜ë©´ JSON ë©”ì‹œì§€ë„ ë³€ê²½í•  ìˆ˜ ìˆë‹¤. í•˜ì§€ë§Œ API ì˜¤ë¥˜ëŠ” ì¡°ê¸ˆ ë’¤ì— ì„¤ëª…í•  `@ExceptionHandler` ê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” ë‚˜ì€ ë°©ë²•ì´ë‹¤.

## API ì˜ˆì™¸ ì²˜ë¦¬ - HandlerExceptionResolver ì‹œì‘

**ëª©í‘œ**

ì˜ˆì™¸ê°€ ë°œìƒí•´ì„œ ì„œë¸”ë¦¿ì„ ë„˜ì–´ WAS ê¹Œì§€ ì˜ˆì™¸ê°€ ì „ë‹¬ë˜ë©´, HTTP ìƒíƒœì½”ë“œê°€ 500ìœ¼ë¡œ ì²˜ë¦¬ëœë‹¤. ë°œìƒí•˜ëŠ” ì˜ˆì™¸ì— ë”°ë¼ 400, 404 ë“±ë“± ë‹¤ë¥¸ ìƒíƒœì½”ë“œë¡œ ì²˜ë¦¬í•˜ê³  ì‹¶ë‹¤.

400 â†’ bad request

404 â†’ not found

ğŸ’¡Â **í•¸ë“¤ëŸ¬ ë‚´ë¶€ì—ì„œ 400 ì—ëŸ¬ê°€ ë°œìƒí•˜ë”ë¼ë„, WAS ì…ì¥ì—ì„œëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ ë‚´ë¶€ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•œ ê²ƒì´ê¸° ë•Œë¬¸ì— ê²°ê³¼ì ìœ¼ë¡œ 500 ì—ëŸ¬ ìƒíƒœ ì½”ë“œê°€ ë°œìƒí•œë‹¤. ì´ë¥¼ í•´ê²°í•´ë³´ì!**

![image.png](9%20API%20%E1%84%8B%E1%85%A8%E1%84%8B%E1%85%AC%20%E1%84%8E%E1%85%A5%E1%84%85%E1%85%B5%2011d29d746aff80a0ad98cd4ea759a997/image%201.png)

â†’ ExceptionResolver ëŠ” ì˜ˆì™¸ë¥¼ í•´ê²°í•´ì„œ ì •ìƒ ë™ì‘ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ (View rendering) ê¹Œì§€ í•  ìˆ˜ ìˆë„ë¡ í•´ì¤€ë‹¤. **ì¦‰, ì˜ˆì™¸ í•´ê²°ì‚¬!**

**HandlerExceptionResolver - interface**

```java
public interface HandlerExceptionResolver {
   ModelAndView resolveException(
   HttpServletRequest request, HttpServletResponse response,
    Object handler, Exception ex);
}
```

- handler : í•¸ë“¤ëŸ¬ (ì»¨íŠ¸ë¡¤ëŸ¬) ì •ë³´
- Exception ex : í•¸ë“¤ëŸ¬ (ì»¨íŠ¸ë¡¤ëŸ¬) ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸

**ApiExceptionController - ì¶”ê°€**

```java
if (id.equals("bad")) {
    throw new IllegalArgumentException("ì˜ëª»ëœ ì…ë ¥ ê°’");
}
```

â†’ ì›í•˜ëŠ” ë™ì‘ : [http://localhost:8080/api/members/bad](http://localhost:8080/api/members/bad) ìš”ì²­ ì‹œ 400 Error code ë°˜í™˜.

**ì´ë¥¼ ìœ„í•´ MyHandlerResolver ìƒì„±**

```java
@Slf4j
public class MyHandlerResolver implements HandlerExceptionResolver {
    @Override
    public ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
        try {
            if (ex instanceof IllegalArgumentException) {
                log.info("IllegalArgumentException resolver to 400");

                response.sendError(HttpServletResponse.SC_BAD_REQUEST, ex.getMessage());
                return new ModelAndView();
            }

        } catch (IOException e) {
            log.error("resolver ex", e);
        }
        return null;
    }
}
```

**WebConfig ì— ë“±ë¡**

```java
@Override
public void extendHandlerExceptionResolvers(List<HandlerExceptionResolver> resolvers) {
    resolvers.add(new MyHandlerResolver());
}
```

- IllegalArgumentException ì´ ë°œìƒí•˜ë©´ response.sendError(400) ì„ í˜¸ì¶œí•´ì„œ HTTP ìƒíƒœ ì½”ë“œë¥¼ 400ìœ¼ë¡œ ì§€ì •í•˜ê³ , ë¹ˆ ModelAndViewë¥¼ ë°˜í™˜í•œë‹¤.

**ë™ì‘ ë°©ì‹**

- ë¹ˆ ModelAndView : new ModelAndView() ì²˜ëŸ¼ ë¹ˆ ModelAndViewë¥¼ ë°˜í™˜í•˜ë©´ ë·°ë¥¼ ëœë”ë§í•˜ì§€ ì•Šê³  ì •ìƒ íë¦„ìœ¼ë¡œ ì„œë¸”ë¦¿ì´ ë¦¬í„´ëœë‹¤.
- ModelAndView ì§€ì • : View, Model ì •ë³´ë¥¼ ì§€ì •í•´ì„œ ë°˜í™˜í•˜ë©´ ë·°ë¥¼ ëœë”ë§ í•œë‹¤.
- null : null ì„ ë°˜í™˜í•˜ë©´, ë‹¤ìŒ ExceptionResolverë¥¼ ì°¾ì•„ì„œ ì‹¤í–‰í•œë‹¤. ë§Œì•½ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ExceptionResolverê°€ ì—†ìœ¼ë©´, ì˜ˆì™¸ ì²˜ë¦¬ê°€ ì•ˆë˜ê³ , ê¸°ì¡´ ë°œìƒí•œ ì˜ˆì™¸ (500) ì„ ì„œë¸”ë¦¿ ë°–ìœ¼ë¡œ ì „ë‹¬í•œë‹¤.

ğŸš¨ ë§Œì•½, WebConfig ì—ì„œ ë‚´ê°€ ë§Œë“  MyHandlerResolver ë¥¼ ë“±ë¡í•  ë•Œ, ì´ë¥¼ ìœ„í•´ `configureHandlerExceptionResolvers(..)` ë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ë©´, ìŠ¤í”„ë§ì´ ê¸°ë³¸ìœ¼ë¡œ ë“±ë¡í•˜ëŠ” `ExceptionResolver` ê°€ ì œê±°ë˜ë¯€ë¡œ ì£¼ì˜í•´ì•¼ í•œë‹¤!

ë°˜ë“œì‹œ `extendHandlerExceptionResolver` ë¥¼ ì‚¬ìš©í•˜ì!

## API ì˜ˆì™¸ ì²˜ë¦¬ - HandlerExceptionResolver í™œìš©

**ì˜ˆì™¸ë¥¼ ì—¬ê¸°ì„œ ë§ˆë¬´ë¦¬í•˜ê¸°**

ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ WASê¹Œì§€ ì˜ˆì™¸ê°€ ë˜ì ¸ì§€ê³ , WAS ì—ì„œ ì˜¤ë¥˜ í˜ì´ì§€ ì •ë³´ë¥¼ ì°¾ì•„ì„œ ë‹¤ì‹œ /error ë¥¼ í˜¸ì¶œí•˜ëŠ” ê³¼ì •ì€ ë³µì¡í•˜ë‹¤. ExceptionResolver ë¥¼ í™œìš©í•˜ë©´, ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì´ëŸ° ë³µì¡í•œ ê³¼ì •ì„ ì—†ì•¨ ìˆ˜ ìˆë‹¤.

ì‚¬ìš©ì ì •ì˜ ì˜ˆì™¸ë¥¼ ì¶”ê°€í•˜ì.

**UserException**

```java
public class UserException extends RuntimeException {
    public UserException() {
        super();
    }

    public UserException(String message) {
        super(message);
    }

    public UserException(String message, Throwable cause) {
        super(message, cause);
    }

    public UserException(Throwable cause) {
        super(cause);
    }

    protected UserException(String message, Throwable cause, boolean enableSuppression, boolean writableStackTrace) {
        super(message, cause, enableSuppression, writableStackTrace);
    }
}

```

**ApiExceptionController ì¶”ê°€**

```java
if (id.equals("user-ex")) {
    throw new UserException("ì‚¬ìš©ì ì˜¤ë¥˜");
}
```

[http://localhost:8080/api/members/user-ex](http://localhost:8080/api/members/user-ex) ìš”ì²­ ì‹œ ì•„ì§ê¹Œì§€ëŠ” 500ì—ëŸ¬ê°€ ë°œìƒí•¨ì„ ì•Œ ìˆ˜ ìˆë‹¤.

**ê²°ê³¼**

```java
{
    "timestamp": "2024-11-01T09:56:50.866+00:00",
    "status": 500,
    "error": "Internal Server Error",
    "path": "/api/members/user-ex"
}
```

**ë”°ë¼ì„œ í•´ë‹¹ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì˜ˆì™¸ Resolver ë¥¼ ë§Œë“¤ì–´ ë³´ì.**

**UserHandlerExceptionResolver**

```java
@Slf4j
public class UserHandlerExceptionResolver implements HandlerExceptionResolver {

    private final ObjectMapper objectMapper = new ObjectMapper();
    @Override
    public ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
        try {
            if (ex instanceof UserException) {
                log.info("UserException resolver to 400");
                String acceptHeader = request.getHeader("accept");
                response.setStatus(HttpServletResponse.SC_BAD_REQUEST);

                if ("application/json".equals(acceptHeader)) {
                    Map<String, Object> errorResult = new HashMap<>();
                    errorResult.put("ex", ex.getClass());
                    errorResult.put("message", ex.getMessage());

                    String result = objectMapper.writeValueAsString(errorResult);

                    response.setContentType("application/json");
                    response.setCharacterEncoding("utf-8");
                    response.getWriter().write(result);
                    return new ModelAndView();
                } else {
                    return new ModelAndView("error/500");
                }
            }

        } catch (IOException e) {
            log.error("resolver ex", e);
        }
        return null;
    }
}

```

**WebConfig ì¶”ê°€**

```java
@Override
public void extendHandlerExceptionResolvers(List<HandlerExceptionResolver> resolvers) {
  resolvers.add(new MyHandlerResolver());
  resolvers.add(new UserHandlerExceptionResolver());
}
```

**ì§ì ‘ ExceptionResolverë¥¼ êµ¬í˜„í•˜ë ¤ê³  í•˜ë‹ˆ ìƒë‹¹íˆ ë³µì¡í•˜ë‹¤. ë”°ë¼ì„œ ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ExceptionResolver ë¥¼ ì•Œì•„ë³´ì.**

## API ì˜ˆì™¸ ì²˜ë¦¬ - ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” Exception Resolver1

ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ê¸°ë³¸ ì œê³µí•˜ëŠ” ExceptionResolver 3ê°€ì§€

1. ExceptionHandlerExceptionResolver
2. ResponseStatusExceptionResolver
3. DefaultHandlerExceptionResolver

1 â†’ 2 â†’ 3 ìˆœì„œë¡œ ìš°ì„ ìˆœìœ„ë¥¼ ê°€ì§„ë‹¤.

**ExceptionHandlerExceptionResolver**

`@ExceptionHandler` ë¥¼ ì²˜ë¦¬í•˜ê³ , API ì˜ˆì™¸ ì²˜ë¦¬ëŠ” ëŒ€ë¶€ë¶„ ì´ ê¸°ëŠ¥ìœ¼ë¡œ í•´ê²°ì´ ê°€ëŠ¥í•˜ë‹¤.

**ResponseStatusExceptionResolver**

HTTP ìƒíƒœì½”ë“œë¥¼ ì§€ì •í•´ì¤€ë‹¤.

ex) `@ResponseStatus(value = HttpStatus.NOT_FOUND)`

### ResponseStatusExceptionResolver

`ResonseStatusExceptionResolver` ëŠ” ì˜ˆì™¸ì— ë”°ë¼ì„œ HTTP ìƒíƒœ ì½”ë“œë¥¼ ì§€ì •í•´ì£¼ëŠ” ì—­í• ì„ í•œë‹¤.

ë‹¤ìŒ ë‘ ê°€ì§€ ê²½ìš°ë¥¼ ì²˜ë¦¬í•œë‹¤.

- `@ResponseStatus` ê°€ ë‹¬ë ¤ìˆëŠ” ì˜ˆì™¸
- `ResponseStatusException` ì˜ˆì™¸

í•˜ë‚˜ì”© í™•ì¸í•´ë³´ì.

ğŸ’¡Â ê¸°ë³¸ ì œê³µ ì‘ë‹µì— ë‚´ìš©ì„ ì¶”ê°€í•˜ê¸° ìœ„í•œ ì„¤ì • ì¶”ê°€.

**application.properties**

```java
server.error.whitelabel.enabled=false
server.error.include-exception=true
server.error.include-message=always
server.error.include-stacktrace=on_param
server.error.include-binding-errors=on_param
```

**BadRequestException**

```java
@ResponseStatus(code = HttpStatus.BAD_REQUEST, reason = "error.bad")
public class BadRequestException extends RuntimeException{
}
```

â†’ `@ResponseStatus` ì• ë…¸í…Œì´ì…˜ì„ ì ìš©í•˜ë©´, í•´ë‹¹ ì˜ˆì™¸ì— ëŒ€í•œ ìƒíƒœì½”ë“œë¥¼ ë³€ê²½í•´ì¤€ë‹¤.

ì¦‰, BadRequest ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ ë°–ìœ¼ë¡œ ë‚˜ê°”ì„ ë•Œ, ResponseStatusExceptionResolver ê°€ í•´ë‹¹ ì• ë…¸í…Œì´ì…˜ì„ í™•ì¸í•´ì„œ ì˜¤ë¥˜ì½”ë“œë¥¼ 500 (`*INTERNAL_SERVER_ERROR`)* ì—ì„œ, 400 ì˜¤ë¥˜ ì½”ë“œë¡œ ë³€ê²½í•˜ê³  ë©”ì‹œì§€ë„ ë‹´ëŠ”ë‹¤.

ì´ë¥¼ ìœ„í•´ 400 ì˜¤ë¥˜ë¥¼ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì¶”ê°€í•œë‹¤.

```java
@GetMapping("api/response-status-ex1")
public String responseStatusEx1() {
    log.info("bad request");
    throw new BadRequestException();
}
```

[http://localhost:8080/api/response-status-ex1](http://localhost:8080/api/response-status-ex1) ìš”ì²­ ë³´ë‚´ê¸°. - postman

**ì‘ë‹µ ê²°ê³¼**

```java
{
    "timestamp": "2024-11-04T03:22:36.008+00:00",
    "status": 400,
    "error": "Bad Request",
    "exception": "hello.exception.exception.BadRequestException",
    "message": "ì˜ëª»ëœ ìš”ì²­ ì˜¤ë¥˜ì…ë‹ˆë‹¤. ë©”ì‹œì§€ ì‚¬ìš©",
    "path": "/api/response-status-ex1"
}
```

**500 ì—ëŸ¬ê°€ ì•„ë‹Œ 400 ì—ëŸ¬ë¡œ ì˜ ë„˜ì–´ì˜´ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.**

## API ì˜ˆì™¸ ì²˜ë¦¬ - ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” ExceptionResolver2

**DefaultHandlerExceptionResolver**

: ìŠ¤í”„ë§ ë‚´ë¶€ì—ì„œ ë°œìƒí•˜ëŠ” ìŠ¤í”„ë§ ì˜ˆì™¸ë¥¼ í•´ê²°í•œë‹¤.

ex) íŒŒë¼ë¯¸í„° ë°”ì¸ë”© ì‹œì ì— íƒ€ì…ì´ ë§ì§€ ì•Šìœ¼ë©´? â†’ TypeMismatchException â‡’ 400 ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ê²ƒì´ ë§ë‹¤. ì´ë¥¼ ìœ„í•´ DefaultHandlerExceptionResolver ëŠ” ì´ê²ƒì„ 500ì˜¤ë¥˜ê°€ ì•„ë‹ˆë¼ 400ì˜¤ë¥˜ë¡œ ë³€ê²½í•´ì¤€ë‹¤.

**ë°”ì¸ë”© ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆë„ë¡ ì»¨íŠ¸ë¡¤ëŸ¬ ì¶”ê°€í•œë‹¤.**

**ApiExceptionController**

```java
@GetMapping("/api/default-handler-ex")
public String defaultException(@RequestParam Integer data) {
    return "ok";
}
```

**ìš”ì²­ ë³´ë‚´ê¸°**

[http://localhost:8080/api/default-handler-ex?data=hello](http://localhost:8080/api/default-handler-ex?data=hello)

**ì‘ë‹µ ê²°ê³¼**

```java
{
    "timestamp": "2024-11-04T03:55:27.371+00:00",
    "status": 400,
    "error": "Bad Request",
    "exception": "org.springframework.web.method.annotation.MethodArgumentTypeMismatchException",
    "message": "Method parameter 'data': Failed to convert value of type 'java.lang.String' to required type 'java.lang.Integer'; For input string: \"hello\"",
    "path": "/api/default-handler-ex"
}
```

**ì¦‰, ìŠ¤í”„ë§ì´ ë‚´ë¶€ ì˜ˆì™¸ ìƒíƒœ ì½”ë“œë¥¼ ì ì ˆíˆ ë³€ê²½í•˜ì—¬ ì•Œë§ì€ ì˜ˆì™¸ ìƒíƒœ ì½”ë“œë¡œ ì‘ë‹µí•œë‹¤.**

## ğŸ’¡*: ì¤‘ìš”!*  API ì˜ˆì™¸ ì²˜ë¦¬ - @ExceptionHandler

**API ì˜ˆì™¸ì²˜ë¦¬ì˜ ì–´ë ¤ìš´ ì **

- HandlerExceptionResolver â†’  ModelAndView ë¥¼ ë°˜í™˜í•´ì•¼ í–ˆë‹¤. í•˜ì§€ë§Œ ì´ëŠ” API ì‘ë‹µì—ëŠ” í•„ìš” ì—†ë‹¤.
- API ì‘ë‹µì„ ìœ„í•´ HttpServletResponse ì— ì§ì ‘ ì‘ë‹µ ë°ì´í„°ë¥¼ ë„£ì–´ì£¼ì—ˆë‹¤.
- íŠ¹ì • ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸ë¥¼ ë³„ë„ë¡œ ì²˜ë¦¬í•˜ê¸° ì–´ë µë‹¤. ë§Œì•½ ì—¬ëŸ¬ ì»¨íŠ¸ë¡¤ëŸ¬ ì¤‘ ì–´ëŠ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ì¸ì§€ íŠ¹ì •í•´ë‚´ê¸° ì‰½ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤.

**â†’ `@ExceptionHandler`** 

ìŠ¤í”„ë§ì€ API ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì• ë…¸í…Œì´ì…˜ `ExceptionHandler` ë¼ëŠ”ê²ƒì„ ì‚¬ìš©í•œë‹¤. 

: `ExceptionHandlerExceptionResolver` 

ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ì ìš©í•  ì»¨íŠ¸ë¡¤ëŸ¬V2 ìƒì„±

**ApiExceptionV2Controller**

```java
@Slf4j
@RestController
public class ApiExceptionV2Controller {

    @GetMapping("/api2/members/{id}")
    public MemberDto getMember(@PathVariable("id") String id) {
        if (id.equals("ex")) {
            throw new RuntimeException("ì˜ëª»ëœ ì‚¬ìš©ì");
        }
        if (id.equals("bad")) {
            throw new IllegalArgumentException("ì˜ëª»ëœ ì…ë ¥ ê°’");
        }
        if (id.equals("user-ex")) {
            throw new UserException("ì‚¬ìš©ì ì˜¤ë¥˜");
        }
        return new MemberDto(id, "hello " + id);
    }
    @Data
    @AllArgsConstructor
    static class MemberDto {
        private String memberId;
        private String name;
    }
}

```

1. IllegalArgumentException ì²˜ë¦¬í•˜ê¸° - ë°©ë²• 1
    1. ì½”ë“œ ì¶”ê°€
        
        ```java
        @ExceptionHandler(IllegalArgumentException.class)
        public ErrorResult illegalExHandler(IllegalArgumentException e) {
            log.error("[exceptionHandler] ex ", e);
            return new ErrorResult("BAD", e.getMessage());
        }
        ```
        
    2. ì‹¤í–‰ ê³¼ì •
        
        í•¸ë“¤ëŸ¬ì—ì„œ ì˜ˆì™¸ ë°œìƒ â†’ DispatcherServletì€ ExceptionResolver ì—ê²Œ ì˜ˆì™¸ í•´ê²° ìš”ì²­ ë³´ë‚´ê³ , ExceptionResolver ì—ì„œ ExceptionHandlerExceptionResolverì—ê²Œ ë¬¼ì–´ë³´ê³ , ì´ê²ƒì´ ì»¨íŠ¸ë¡¤ëŸ¬ì— ì• ë…¸í…Œì´ì…˜ â€œExceptionHandlerâ€ ê°€ ìˆëŠ”ì§€ ì°¾ì•„ë³¸ë‹¤. ë§Œì•½ ì• ë…¸í…Œì´ì…˜ì´ ìˆìœ¼ë©´, ì• ë…¸í…Œì´ì…˜ì´ ë¶™ì€ ë©”ì„œë“œë¥¼ ì‹¤í–‰í•œë‹¤.  
        
    
    **â†’ ë¬¸ì œì  : ì´ ê³¼ì •ì„ í†µí•´, ì—ëŸ¬ê°€ ë°œìƒí–ˆì§€ë§Œ, ì •ìƒ ë™ì‘ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ ìƒíƒœì½”ë“œëŠ” ì •ìƒ â€œ200â€ ìœ¼ë¡œ ë°˜í™˜ëœë‹¤. ìƒíƒœì½”ë“œëŠ” ì›ë˜ì˜ ìƒíƒœì½”ë“œë¥¼ ì¶”ê°€í•´ì„œ ë°”ê¿”ì•¼ í•œë‹¤.**
    
    **í•´ê²°ë²• :** `@ResponseStatus(HttpStatus.BAD_REQUEST)` ì¶”ê°€.
    
2. UserException ì²˜ë¦¬í•˜ê¸° - ë°©ë²• 2
    1. ì½”ë“œ ì¶”ê°€
        
        ```java
        @ExceptionHandler
        public ResponseEntity<ErrorResult> userExHandler(UserException e) {
            log.error("[exceptionHandler] ex ", e);
            ErrorResult errorResult = new ErrorResult("USER-EX", e.getMessage());
            return new ResponseEntity<>(errorResult, HttpStatus.BAD_REQUEST);
        }
        ```
        
    2. ì½”ë“œ ì„¤ëª…
        
        ResponseStatus ì• ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ì§ì ‘ ResponseEntityë¥¼ ë°˜í™˜í•˜ë„ë¡ í•  ìˆ˜ ìˆë‹¤.
        
        ExceptionHandler ì• ë…¸í…Œì´ì…˜ì˜ argument ëŠ” ë©”ì„œë“œ argumentì™€ ì¼ì¹˜í•œë‹¤ë©´, ìƒëµí•  ìˆ˜ ìˆë‹¤.
        
3. Internal server Error

Exception â†’ RuntimeException â†’ UserException, IlltgalArgumentException â€¦ 
ìœ„ì˜ IllegalArgumentException ì˜ˆì™¸ì²˜ë¦¬ì—ì„œëŠ” ê·¸ ìì‹ê¹Œì§€ ì˜ˆì™¸ë¥¼ ì¡ì•„ì¤€ë‹¤. ë§Œì•½ ìœ„ì—ì„œ ëª» ì¡ì€ ì˜ˆì™¸ì˜ ê²½ìš°,

```java
@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
@ExceptionHandler
public ErrorResult exHandler(Exception e) {
    log.error("[exceptionHandler] ex ", e);
    return new ErrorResult("EX", "ë‚´ë¶€ ì˜¤ë¥˜");
}
```

â†’ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•œë‹¤.

â‡’ ì´ë¥¼ í†µí•´ ì˜ˆìƒì¹˜ ëª»í•˜ê±°ë‚˜, ê³µí†µìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸° ì›í•˜ëŠ” ì˜ˆì™¸ì— ëŒ€í•´ì„œ ì„¤ì •ë„ ê°€ëŠ¥í•˜ë‹¤.

**ìš°ì„  ìˆœìœ„**

```java
@ExceptionHandler(ë¶€ëª¨ì˜ˆì™¸.class)
public String ë¶€ëª¨ì˜ˆì™¸ì²˜ë¦¬()(ë¶€ëª¨ì˜ˆì™¸ e) {}

@ExceptionHandler(ìì‹ì˜ˆì™¸.class)
public String ìì‹ì˜ˆì™¸ì²˜ë¦¬()(ìì‹ì˜ˆì™¸ e) {}
```

â†’ ìì„¸í•œ ê²ƒì´ ìš°ì„ ê¶Œì„ ê°€ì§„ë‹¤, ì¦‰. ìì‹ì˜ˆì™¸ì²˜ë¦¬() ê°€ ìš°ì„ ê¶Œì„ ê°€ì ¸ ì‹¤í–‰ ëœë‹¤.

## API ì˜ˆì™¸ ì²˜ë¦¬ - @ControllerAdvice

**ìœ„ ì½”ë“œ â€œ@ExceptionHandlerâ€ ë¬¸ì œì  : ì •ìƒì½”ë“œ (ì»¨íŠ¸ë¡¤ëŸ¬) ì™€ ì˜ˆì™¸ ì²˜ë¦¬ ì½”ë“œê°€ í•˜ë‚˜ì˜ ì»¨íŠ¸ë¡¤ëŸ¬ ì•ˆì— ì„ì—¬ìˆë‹¤. ì´ë¥¼ ë¶„ë¦¬í•˜ê³ ì‹¶ë‹¤!**

â†’ â€œ`@ControllerAdvice`â€ or â€œ`@RestControllerAdvice`â€

**â€œ`@RestControllerAdvice`â€ = â€œ`@ControllerAdvice`â€ + â€œ`@ResponseBody`â€**

**ExControllerAdvice**

```java
@Slf4j
@RestControllerAdvice
public class ExControllerAdvice {
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    @ExceptionHandler(IllegalArgumentException.class)
    public ErrorResult illegalExHandler(IllegalArgumentException e) {
        log.error("[exceptionHandler] ex ", e);
        return new ErrorResult("BAD", e.getMessage());
    }

    @ExceptionHandler
    public ResponseEntity<ErrorResult> userExHandler(UserException e) {
        log.error("[exceptionHandler] ex ", e);
        ErrorResult errorResult = new ErrorResult("USER-EX", e.getMessage());
        return new ResponseEntity<>(errorResult, HttpStatus.BAD_REQUEST);
    }

    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    @ExceptionHandler
    public ErrorResult exHandler(Exception e) {
        log.error("[exceptionHandler] ex ", e);
        return new ErrorResult("EX", "ë‚´ë¶€ ì˜¤ë¥˜");
    }

    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    @ExceptionHandler
    public ErrorResult exHandler(RuntimeException e) {
        log.error("[exceptionHandler] ex ", e);
        return new ErrorResult("Runtime EX", "ëŸ°íƒ€ì„ ë‚´ë¶€ ì˜¤ë¥˜");
    }
}

```

**ê·¸ë¦¬ê³ , ApiExceptionV2Controller ì—ëŠ” ì˜ˆì™¸ ì²˜ë¦¬ ì½”ë“œë¥¼ ì£¼ì„ì²˜ë¦¬ í•¨.**

í˜„ì¬ â€œ`@RestControllerAdvice`â€ ì— ëŒ€ìƒì„ ì§€ì •í•˜ì§€ ì•Šì•˜ë‹¤ â†’ ê·¸ëŸ¬ë©´ ëª¨ë“  ì»¨íŠ¸ë¡¤ëŸ¬ì— ì ìš©ëœë‹¤ : ê¸€ë¡œë²Œ ì ìš©.

**ëŒ€ìƒ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì§€ì •í•˜ëŠ” ë°©ë²• 3ê°€ì§€.**

1. ì• ë…¸í…Œì´ì…˜ì— ë”°ë¼ ì§€ì •
2. íŒ¨í‚¤ì§€ ê²½ë¡œë¡œ ì§€ì •
3. íŠ¹ì • í´ë˜ìŠ¤ì— ì§€ì •

```java
// 1. Target all Controllers annotated with @RestController
@ControllerAdvice(annotations = RestController.class)
public class ExampleAdvice1 {}

// 2. Target all Controllers within specific packages
@ControllerAdvice("org.example.controllers")
public class ExampleAdvice2 {}

// 3. Target all Controllers assignable to specific classes
@ControllerAdvice(assignableTypes = {ControllerInterface.class,
AbstractController.class})
public class ExampleAdvice3 {}
```