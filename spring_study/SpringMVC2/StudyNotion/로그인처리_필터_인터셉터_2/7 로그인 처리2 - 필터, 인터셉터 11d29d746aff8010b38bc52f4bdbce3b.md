# 7. ë¡œê·¸ì¸ ì²˜ë¦¬2 - í•„í„°, ì¸í„°ì…‰í„°

í˜„ì¬ ë¡œê·¸ì¸ ì•ˆí•œ ì‚¬ìš©ìë„ ìƒí’ˆ ê´€ë¦¬ í˜ì´ì§€ì— ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë‹¤.

ëª¨ë“  ì»¨íŠ¸ë¡¤ëŸ¬ ë¡œì§ì— ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ ì²´í¬í•˜ëŠ” ê³¼ì •ì„ ì¶”ê°€í•´ì•¼ í•  ê¹Œ?

ë°˜ë³µë˜ëŠ” ê¸°ëŠ¥ì´ë‹¤. ë”°ë¼ì„œ ì´ë¥¼ ê³µí†µìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” â€œì„œë¸”ë¦¿ í•„í„°â€ ê°€ ìˆë‹¤.

## ì„œë¸”ë¦¿ í•„í„°

ì—¬ëŸ¬ ë¡œì§ì—ì„œ ê³µí†µìœ¼ë¡œ ê´€ì‹¬ì´ ìˆëŠ” ê²ƒì„ ê³µí†µ ê´€ì‹¬ì‚¬ë¼ê³  í•œë‹¤.

ê³µí†µ ê´€ì‹¬ì‚¬ëŠ” ìŠ¤í”„ë§ì˜ AOPë¡œ í•´ê²°í•  ìˆ˜ ìˆì§€ë§Œ, ì›¹ê³¼ ê´€ë ¨ëœ ê³µí†µ ê´€ì‹¬ì‚¬ëŠ” ì„œë¸”ë¦¿ í•„í„° ë˜ëŠ” ìŠ¤í”„ë§ ì¸í„°ì…‰í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

### ìŠ¤í”„ë§ì˜ AOP?

â†’ ê´€ì  ì§€í–¥ í”„ë¡œê·¸ë˜ë°ì´ë‹¤.

ì–´ë–¤ ë¡œì§ì„ ê¸°ì¤€ìœ¼ë¡œ í•µì‹¬ì ì¸ ê´€ì , ë¶€ê°€ì ì¸ ê´€ì ìœ¼ë¡œ ë‚˜ëˆ„ì–´ì„œ ë³´ê³ , ê·¸ ê´€ì ì„ ê¸°ì¤€ìœ¼ë¡œ ê°ê° ëª¨ë“ˆí™” í•˜ê² ë‹¤ â†’ ëª¨ë“ˆí™”ëŠ”? : ê³µí†µ ë¡œì§ì´ë‚˜ ê¸°ëŠ¥ì„ í•˜ë‚˜ì˜ ë‹¨ìœ„ë¡œ ë¬¶ëŠ”ê²ƒ.

â†’ ì´ë•Œ, ê³µí†µìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ë¡œì§ì´ë‚˜ ê¸°ëŠ¥ì˜ ì½”ë“œë“¤ì„ â€œCrocss Cutting Concernsâ€ í©ì–´ì§„ ê´€ì‹¬ì‚¬ ë¼ê³  í•œë‹¤.

**ë”°ë¼ì„œ, AOPë¡œ í•´ê²°í•  ìˆ˜ ìˆì§€ë§Œ â†’ ë¡œê·¸ì¸ ê²€ì¦ì— ê´€í•œ ë¡œì§ì„ ë³„ë„ë¡œ í´ë˜ìŠ¤í™” í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ, ì›¹ê³¼ ê´€ë ¨ëœ ê³µí†µ ê´€ì‹¬ì‚¬ì¸ ë¡œê·¸ì¸ ê²€ì¦ì—ì„œëŠ” ì„œë¸”ë¦¿ í•„í„° ë˜ëŠ” ìŠ¤í”„ë§ ì¸í„°ì…‰í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.**

**í•„í„° íë¦„**

```java
HTTP ìš”ì²­ -> WAS -> í•„í„° -> ì„œë¸”ë¦¿ -> ì»¨íŠ¸ë¡¤ëŸ¬
```

**í•„í„° ì œí•œ**

```java
HTTP ìš”ì²­ -> WAS -> í•„í„° -> ì„œë¸”ë¦¿ -> ì»¨íŠ¸ë¡¤ëŸ¬ //ë¡œê·¸ì¸ ì‚¬ìš©ì
HTTP ìš”ì²­ -> WAS -> í•„í„°(ì ì ˆí•˜ì§€ ì•Šì€ ìš”ì²­ì´ë¼ íŒë‹¨, ì„œë¸”ë¦¿ í˜¸ì¶œ í•˜ì§€ ì•ŠìŒ) //ë¹„ ë¡œê·¸ì¸ ì‚¬ìš©ì
```

í•„í„°ì—ì„œ ì ì ˆí•˜ì§€ ì•Šì€ ìš”ì²­ì´ë¼ê³  íŒë‹¨í•˜ë©´, ê±°ê¸°ì—ì„œ ëë‚¼ ìˆ˜ë„ ìˆë‹¤. ê·¸ë˜ì„œ ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ ì²´í¬í•˜ê¸° ì¢‹ë‹¤.

**í•„í„° ì²´ì¸**

í•„í„°ëŠ” ì²´ì¸ìœ¼ë¡œ êµ¬ì„±ë˜ëŠ”ë°, ì¤‘ê°„ì— í•„í„°ë¥¼ ììœ ë¡­ê²Œ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.

í•˜ë‚˜ì˜ HTTP ìš”ì²­ì´ ë“¤ì–´ì™€ì„œ ë‚˜ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë¡œê·¸ë¥¼ ë‚¨ê¸¸ ë•ŒëŠ” ì „ë¶€ ë‹¤ ìë™ìœ¼ë¡œ uuidë¥¼ ë‚¨ê¸°ê³  ì‹¶ë‹¤? â†’ ë¡œê·¸ê°€ ë‚¨ì„ ë•Œ uuidë¥¼ í†µí•´ ì¶”ì •ì´ ì‰½ë‹¤. : logback.mdc ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

**í•„í„° ì¸í„°í˜ì´ìŠ¤**

```java
public interface Filter {

	public default void init(FilterConfig filterConfig) throws ServletException {}

	public void doFilter(ServletRequest request, ServletResponse response,
      FilterChain chain) throws IOException, ServletException;

  public default void destroy() {}
}
```

**í•„í„° ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê³ , ë“±ë¡í•˜ë©´ ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆê°€ í•„í„°ë¥¼ ì‹±ê¸€í†¤ ê°ì²´ë¡œ ìƒì„±í•˜ê³ , ê´€ë¦¬í•œë‹¤.**

- init() : í•„í„° ì´ˆê¸°í™” ë©”ì„œë“œ, ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆê°€ ìƒì„±ë  ë•Œ í˜¸ì¶œëœë‹¤.
- doFilter() : ê³ ê°ì˜ ìš”ì²­ì´ ì˜¬ ë•Œ ë§ˆë‹¤ í•´ë‹¹ ë©”ì„œë“œê°€ í˜¸ì¶œëœë‹¤. í•„í„°ì˜ ë¡œì§ì„ êµ¬í˜„í•˜ë©´ ëœë‹¤.
- destroy() : í•„í„° ì¢…ë£Œ ë©”ì„œë“œ, ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë  ë•Œ í˜¸ì¶œëœë‹¤.

## ì„œë¸”ë¦¿ í•„í„° - ìš”ì²­ ë¡œê·¸

í•„í„°ê°€ ì •ë§ ì˜ ë™ì‘ í•˜ëŠ”ì§€, ëª¨ë“  ìš”ì²­ì„ ë¡œê·¸ë¡œ ë‚¨ê¸°ëŠ” í•„í„°ë¥¼ ê°œë°œí•˜ê³  ì ìš©í•´ë³´ì.

**LogFilter**

```java
@Slf4j
public class LogFilter implements Filter {
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        log.info("log filter init");
    }

    //http ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ doFilter ê°€ ì‹¤í–‰ëœë‹¤.
    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        log.info("log filter doFilter");
        HttpServletRequest httpRequest = (HttpServletRequest) servletRequest;
        String requestURI = httpRequest.getRequestURI();
        String uuid = UUID.randomUUID().toString();

        try{
            log.info("REQUEST [{}] [{}]", uuid, requestURI);
            filterChain.doFilter(servletRequest, servletResponse);

        } catch (Exception e) {
            throw e;
        } finally {
            log.info("RESPONSE [{}] [{}]", uuid, requestURI);
        }
    }

    @Override
    public void destroy() {
        log.info("log filter destroy");
    }
}

```

- í•„í„°ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ Filter interface ë¥¼ êµ¬í˜„í•œë‹¤
- doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)
    - HTTP ìš”ì²­ì´ ì˜¤ë©´, doFilterê°€ í˜¸ì¶œëœë‹¤.
    - ì™œ HttpServletRequest, HttpServletResponse ê°€ ì•„ë‹ˆê³  ê·¸ëƒ¥ ServletRequest, Response ì¼ê¹Œ?
        - HTTP ìš”ì²­ì´ ì•„ë‹Œ ê²½ìš°ê¹Œì§€ ê³ ë ¤í•´ì„œ ë§Œë“  ì¸í„°í˜ì´ìŠ¤ì´ê¸° ë•Œë¬¸ì—, (HttpServletRequset) ë¥¼ ì‚¬ìš©í•´ì„œ ë‹¤ìš´ ìºìŠ¤íŒ… í•´ì£¼ì–´ì•¼ í•œë‹¤.
- String uuid = UUID.randomUUID().toString()
    - HTTP ìš”ì²­ì„ êµ¬ë¶„í•˜ê¸° ìœ„í•´ ì„ì˜ì˜ ëœë¤ê°’ì„ ìƒì„±í•œë‹¤.
- log.info("REQUEST [{}] [{}]", uuid, requestURI);
    - uuid, requestURI ë¥¼ ì¶œë ¥í•œë‹¤.
- chain.doFilter(request, response);
    - ë‹¤ìŒ í•„í„°ê°€ ìˆìœ¼ë©´, í•„í„°ë¥¼ í˜¸ì¶œí•˜ê³ , ì—†ìœ¼ë©´ ì„œë¸”ë¦¿ì„ í˜¸ì¶œí•œë‹¤.
    - ğŸ’¡Â **ì´ ë¡œì§ì„ í˜¸ì¶œí•˜ì§€ ì•Šìœ¼ë©´, ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤!!! ì¤‘ìš”!!**

**main package â†’ WebConfig.class ìƒì„±**

```java
@Configuration
public class WebConfig {
    @Bean
    public FilterRegistrationBean logFilter() {
        FilterRegistrationBean<Filter> filterFilterRegistrationBean = new FilterRegistrationBean<>();
        filterFilterRegistrationBean.setFilter(new LogFilter());
        filterFilterRegistrationBean.setOrder(1);
        filterFilterRegistrationBean.addUrlPatterns("/*");

        return filterFilterRegistrationBean;
    }
}
```

**ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ ì‚¬ìš©í•œë‹¤ë©´, FilterRegistrationBean ì„ ì‚¬ìš©í•´ì„œ í•„í„°ë¥¼ ë“±ë¡í•œë‹¤!**

- setFilter() : ë“±ë¡í•  í•„í„° ì§€ì •
- setOrder() : í•„í„° ì²´ì¸ì˜ ìˆœì„œ - ë‚®ì„ ìˆ˜ë¡ ë¨¼ì € ë™ì‘í•œë‹¤
- addUrlPatterns() : í•„í„°ë¥¼ ì ìš©í•  URL íŒ¨í„´ì„ ì§€ì •

## ì„œë¸”ë¦¿ í•„í„° - ì¸ì¦ ì²´í¬

ë¡œê·¸ë¥¼ ì°ëŠ” í•„í„°ëŠ” ì™„ë£Œ, ì´ì œ ì¸ì¦ ì²´í¬ í•„í„°ë¥¼ ê°œë°œí•˜ì. ë¡œê·¸ì¸ ë˜ì§€ ì•Šì€ ì‚¬ìš©ìëŠ” ìƒí’ˆ ê´€ë¦¬ ë¿ë§Œ ì•„ë‹ˆë¼, ì•ìœ¼ë¡œ ê°œë°œë  í˜ì´ì§€ì—ë„ ì ‘ê·¼í•˜ì§€ ëª»í•˜ë„ë¡ í•˜ê³ ì‹¶ë‹¤.

**LoginCheckFilter - ì¸ì¦ ì²´í¬ í•„í„°**

```java
@Slf4j
public class LoginCheckFilter implements Filter {
    private static final String[] whitelist = {"/", "/members/add", "/login", "/logout", "/css/*"};

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest httpRequest = (HttpServletRequest) servletRequest;
        String requestURI = httpRequest.getRequestURI();
        HttpServletResponse httpResponse = (HttpServletResponse) servletResponse;

        try {
            log.info("ì¸ì¦ ì²´í¬ í•„í„° ì‹œì‘ {}", requestURI);

            if (isLoginCheckPath(requestURI)) {
                log.info("ì¸ì¦ ì²´í¬ ë¡œì§ ì‹¤í–‰ {}", requestURI);
                HttpSession session = httpRequest.getSession(false);
                if (session == null || session.getAttribute(SessionConst.LOGIN_MEMBER) == null) {
                    log.info("ë¯¸ì¸ì¦ ì‚¬ìš©ì ìš”ì²­ {}", requestURI);
                    httpResponse.sendRedirect("/login?redirectURL=" + requestURI);
                    return;
                }
            }

            filterChain.doFilter(servletRequest, servletResponse);
        } catch (Exception e) {
            throw e;
        } finally {
            log.info("ì¸ì¦ ì²´í¬ í•„í„° ì¢…ë£Œ {}", requestURI);
        }
    }

    /**
     * í™”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸ì¸ ê²½ìš° ì¸ì¦ ì²´í¬ ì•ˆí•˜ë„ë¡ í•˜ëŠ” ë©”ì„œë“œ
     */
    private boolean isLoginCheckPath(String requestURI) {
        return !PatternMatchUtils.simpleMatch(whitelist, requestURI);
    }
}

```

- whitelist â†’ â€œ/â€ , â€œ/members/addâ€ , â€œ/loginâ€ , â€œ/logoutâ€ , â€œ/css/*
    - ì¸ì¦ í•„í„°ì—ì„œ í•­ìƒ í—ˆìš©ë˜ëŠ” URL ì„ whitelist listë¡œ ê´€ë¦¬í•œë‹¤.
- isLoginCheckPath(requestURI) : Boolean
    - PatternMatchUtils.simpleMatch(whitelist, requestURI) : match í•˜ë©´ true
- httpResponse.sendRedirect(â€/login?redirectURL=â€ + requestURI);
    - ë¯¸ ì¸ì¦ ì‚¬ìš©ìëŠ” ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ë‹¤ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•˜ê³ , ë¡œê·¸ì¸ ì´í›„ì— ë‹¤ì‹œ í™ˆìœ¼ë¡œ ì´ë™í•˜ë©´ ì›í•˜ëŠ” ê²½ë¡œë¥¼ ì§ì ‘ ë‹¤ì‹œ ì°¾ì•„ê°€ì•¼ í•œë‹¤.
- ë§Œì•½, ë¡œê·¸ì¸ì„ í•´ì•¼í•˜ëŠ” ì‚¬ìš©ìë¡œ íŒë‹¨ëœë‹¤ë©´,
    - httpResponse.sendRedirect(â€/login?redirectURL=â€ + requestURI); redirect ì‘ë‹µì„ ë³´ë‚´ê³ ,
        
        **return; í•´ì¤€ë‹¤. â†’ í•„í„°ë¥¼ ë” ì§„í–‰í•˜ì§€ ì•Šê³ , ì„œë¸”ë¦¿, í•¸ë“¤ëŸ¬(ì»¨íŠ¸ë¡¤ëŸ¬) ëª¨ë‘ í˜¸ì¶œë˜ì§€ ì•Šë„ë¡ í•œë‹¤.**
        

**WebConfig - loginCheckFilter() ì¶”ê°€**

```java
@Bean
public FilterRegistrationBean loginCheckFilter() {
    FilterRegistrationBean<Filter> filterFilterRegistrationBean = new FilterRegistrationBean<>();
    filterFilterRegistrationBean.setFilter(new LoginCheckFilter());
    filterFilterRegistrationBean.setOrder(2);
    filterFilterRegistrationBean.addUrlPatterns("/*");

    return filterFilterRegistrationBean;
}
```

- setFilter(new LoginCheckFilter() ) : ë¡œê·¸ì¸ í•„í„°ë¥¼ ë“±ë¡í•œë‹¤
- setOrder(2) : ìˆœì„œë¥¼ 2ë²ˆìœ¼ë¡œ ì¡ì•˜ë‹¤. ë¡œê·¸ í•„í„° ë‹¤ìŒì— ë¡œê·¸ì¸ í•„í„°ê°€ ì ìš©ëœë‹¤
- addUrlPatterns(â€ /* â€) : ëª¨ë“  ìš”ì²­ì— ë¡œê·¸ì¸ í•„í„°ë¥¼ ì ìš©í•œë‹¤

**RedirectURL ì²˜ë¦¬**

ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ ì²˜ìŒ ìš”ì²­í•œ URLë¡œ ì´ë™í•˜ëŠ” ê¸°ëŠ¥ì„ ê°œë°œí•´ë³´ì.

**LoginController - loginV4()**

```java
@PostMapping("/login")
public String loginV4(@Valid @ModelAttribute LoginForm form, BindingResult bindingResult, HttpServletRequest request, @RequestParam(defaultValue = "/") String redirectURL) {
    if (bindingResult.hasErrors()) {
        return "login/loginForm";
    }
    Member loginMember = loginService.login(form.getLoginId(), form.getPassword());
    if (loginMember == null) {
		    //ë¡œê·¸ì¸ ì‹¤íŒ¨
        bindingResult.reject("loginFail", "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤");
        return "login/loginForm";
    }
    HttpSession session = request.getSession();
    session.setAttribute(SessionConst.LOGIN_MEMBER, loginMember);
    return "redirect:" + redirectURL;
}
```

- ë¡œê·¸ì¸ ì²´í¬ í•„í„°ì—ì„œ, ë¯¸ì¸ì¦ ì‚¬ìš©ìëŠ” ìš”ì²­ ê²½ë¡œë¥¼ í¬í•¨í•˜ì—¬ `/login` ì— `redirectURL` ìš”ì²­ íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•˜ì—¬ ìš”ì²­í–ˆê³ , ì´ë¥¼ redirect ì‹œì¼œ ì¤Œ.

## ìŠ¤í”„ë§ ì¸í„°ì…‰í„° - ì†Œê°œ

ìŠ¤í”„ë§ ì¸í„°ì…‰í„°ì—ì„œë„ ì„œë¸”ë¦¿ í•„í„°ì™€ ê°™ì´ ì›¹ê³¼ ê´€ë ¨ëœ ê³µí†µ ê´€ì‹¬ ì‚¬í•­ì„ íš¨ê³¼ì ìœ¼ë¡œ í•´ê²°í•  ìˆ˜ ìˆëŠ” ê¸°ìˆ ì´ë‹¤.

ì„œë¸”ë¦¿ í•„í„°ê°€ ì„œë¸”ë¦¿ì´ ì œê³µí•˜ëŠ” ê¸°ìˆ ì´ë¼ë©´, ìŠ¤í”„ë§ ì¸í„°ì…‰í„°ëŠ” ìŠ¤í”„ë§MVC ê°€ ì œê³µí•˜ëŠ” ê¸°ìˆ ì´ë‹¤. ë‘˜ë‹¤ ì›¹ê³¼ ê´€ë ¨ëœ ê³µí†µ ê´€ì‹¬ ì‚¬í•­ì„ ì²˜ë¦¬í•˜ì§€ë§Œ, ì ìš©ë˜ëŠ” ìˆœì„œì™€ ë²”ìœ„, ê·¸ë¦¬ê³  ì‚¬ìš©ë°©ë²•ì´ ë‹¤ë¥´ë‹¤.

**ìŠ¤í”„ë§ ì¸í„°ì…‰í„° íë¦„**

```java
HTTP ìš”ì²­ -> WAS -> í•„í„° -> ì„œë¸”ë¦¿ -> ***ìŠ¤í”„ë§ ì¸í„°ì…‰í„°*** -> ì»¨íŠ¸ë¡¤ëŸ¬ (í•¸ë“¤ëŸ¬)
```

- ìŠ¤í”„ë§ ì¸í„°ì…‰í„°ëŠ” ë””ìŠ¤íŒ¨ì²˜ ì„œë¸”ë¦¿ê³¼ ì»¨íŠ¸ë¡¤ëŸ¬ ì‚¬ì´ì—ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ í˜¸ì¶œ ì§ì „ì— í˜¸ì¶œëœë‹¤.
- ìŠ¤í”„ë§ ì¸í„°ì…‰í„°ì—ë„ URL íŒ¨í„´ì„ ì ìš©í•  ìˆ˜ ìˆëŠ”ë°, ì„œë¸”ë¦¿ URL íŒ¨í„´ê³¼ëŠ” ë‹¤ë¥´ê³ , ë§¤ìš° ì •ë°€í•˜ê²Œ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

**ìŠ¤í”„ë§ ì¸í„°ì…‰í„° ì œí•œ**

```java
HTTP ìš”ì²­ -> WAS -> í•„í„° -> ì„œë¸”ë¦¿ -> ìŠ¤í”„ë§ ì¸í„°ì…‰í„° -> ì»¨íŠ¸ë¡¤ëŸ¬ //ë¡œê·¸ì¸ ì‚¬ìš©ì
HTTP ìš”ì²­ -> WAS -> í•„í„° -> ì„œë¸”ë¦¿ -> ìŠ¤í”„ë§ ì¸í„°ì…‰í„° 
(ì ì ˆí•˜ì§€ ì•Šì€ ìš”ì²­ì´ë¼ íŒë‹¨, ì»¨íŠ¸ë¡¤ëŸ¬ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤.)
// ë¹„ ë¡œê·¸ì¸ ì‚¬ìš©ì
```

**ìŠ¤í”„ë§ ì¸í„°ì…‰í„° ì²´ì¸**

```java
HTTP ìš”ì²­ -> WAS -> í•„í„° -> ì„œë¸”ë¦¿ -> ì¸í„°ì…‰í„°1 -> ì¸í„°ì…‰í„°2 -> ì»¨íŠ¸ë¡¤ëŸ¬
```

ìŠ¤í”„ë§ ì¸í„°ì…‰í„°ëŠ” ì²´ì¸ìœ¼ë¡œ êµ¬ì„±ë˜ëŠ”ë°, ì¤‘ê°„ì— ì¸í„°ì…‰í„°ë¥¼ ììœ ë¡­ê²Œ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ì¸í„°ì…‰í„°ë¥¼ ë¨¼ì € ì ìš©í•˜ê³ , ê·¸ ë‹¤ìŒì— ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ ì²´í¬í•˜ëŠ” ì¸í„°ì…‰í„°ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

**ìŠ¤í”„ë§ ì¸í„°ì…‰í„° ì¸í„°í˜ì´ìŠ¤**

**HandlerInterceptor interface**

```java
public interface HandlerInterceptor {
	default boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
			throws Exception {

		return true;
	}
	default void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler,
			@Nullable ModelAndView modelAndView) throws Exception {
	}
	default void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler,
			@Nullable Exception ex) throws Exception {
	}
}
```

- ì„œë¸”ë¦¿ í•„í„°ëŠ” doFilter() í•˜ë‚˜ë§Œ ì œê³µí•˜ì˜€ë‹¤.
- í•˜ì§€ë§Œ ì¸í„°ì…‰í„°ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ í˜¸ì¶œ ì „ - preHandle, í˜¸ì¶œ í›„ - postHandle, ìš”ì²­ ì™„ë£Œ ì´í›„ - afterCompletion ê³¼ ê°™ì´ ë‹¨ê³„ì ìœ¼ë¡œ ì˜ ì„¸ë¶„í™” ë˜ì–´ ìˆë‹¤.

![image.png](https://github.com/cjw0324/Spring_Study/blob/main/spring_study/SpringMVC2/StudyNotion/%EB%A1%9C%EA%B7%B8%EC%9D%B8%EC%B2%98%EB%A6%AC_%ED%95%84%ED%84%B0_%EC%9D%B8%ED%84%B0%EC%85%89%ED%84%B0_2/7%20%EB%A1%9C%EA%B7%B8%EC%9D%B8%20%EC%B2%98%EB%A6%AC2%20-%20%ED%95%84%ED%84%B0%2C%20%EC%9D%B8%ED%84%B0%EC%85%89%ED%84%B0%2011d29d746aff8010b38bc52f4bdbce3b/image.png)

**ì •ìƒ íë¦„**

- preHandle : ì»¨íŠ¸ë¡¤ëŸ¬ í˜¸ì¶œ ì „ í˜¸ì¶œë¨ - true : í•¸ë“¤ëŸ¬ ì–´ëŒ‘í„° í˜¸ì¶œ
- postHandle : ì»¨íŠ¸ë¡¤ëŸ¬ í˜¸ì¶œ í›„ í˜¸ì¶œ
- afterCompletion : ë·°ê°€ ëœë”ë§ ëœ ì´í›„ í˜¸ì¶œ

**afterCompletionì€ ì˜ˆì™¸ê°€ ë°œìƒí•´ë„ í˜¸ì¶œëœë‹¤.**

- ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ postHandle()ì€ í˜¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤. ì˜ˆì™¸ì™€ ë¬´ê´€í•˜ê²Œ ê³µí†µì²˜ë¦¬ë¥¼ í•˜ë ¤ë©´ **`afterCompletion()` ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.**

## ìŠ¤í”„ë§ ì¸í„°ì…‰í„° - ìš”ì²­ ë¡œê·¸

**LogInterceptor**

```java
@Slf4j
public class LogInterceptor implements HandlerInterceptor {
    private static final String LOG_ID = "logId";

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        String requestURI = request.getRequestURI();
        String uuid = UUID.randomUUID().toString();

        request.setAttribute(LOG_ID, uuid); //ì¤‘ìš”!!

        if (handler instanceof HandlerMethod) {
            HandlerMethod hm = (HandlerMethod) handler;
        }

        log.info("REQUEST [{}] [{}] [{}]", uuid, requestURI, handler);
        return true;

    }

    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        log.info("postHandle [{}]", modelAndView);
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        String requestURI = request.getRequestURI();
        String logId = (String) request.getAttribute(LOG_ID);

        log.info("RESPONSE [{}] [{}] [{}]", logId, requestURI, handler);
        if (ex != null) {
            log.error("afterCompletion error!!", ex);
        }

    }
}

```

- request.setAttribute(LOG_ID, uuid) :
    - ì„œë¸”ë¦¿ í•„í„°ì˜ ê²½ìš° ì§€ì—­ë³€ìˆ˜ë¡œ í•´ê²°ì´ ê°€ëŠ¥í•˜ì§€ë§Œ, ìŠ¤í”„ë§ ì¸í„°ì…‰í„°ëŠ” í˜¸ì¶œ ì‹œì ì´ ì™„ì „íˆ ë¶„ë¦¬ë˜ì–´ ìˆë‹¤.
    - ë”°ë¼ì„œ preHandleì—ì„œ ì§€ì •í•œ ê°’ì„ **postHandle, afterCompletion ì—ì„œ í•¨ê»˜ ì‚¬ìš©í•˜ë ¤ë©´ ì–´ë””ì— ë‹´ì•„ë‘ì–´ì•¼ í•˜ëŠ”ë°**, LogInterceptor ë„ ì‹±ê¸€í†¤ ì²˜ëŸ¼ ì‚¬ìš©ë˜ê¸° ë•Œë¬¸ì— ë©¤ë²„ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ ìœ„í—˜í•˜ë‹¤.
    - **ë”°ë¼ì„œ request ì— ë‹´ì•„ë‘ì—ˆê³ , ì´ ê°’ì€ afterCompletion ì—ì„œ request.getAttribute(LOG_ID)ë¡œ ì°¾ì•„ì„œ ì‚¬ìš©í•œë‹¤.**

**WebConfig - ì¸í„°ì…‰í„° ë“±ë¡**

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new LogInterceptor()).order(1).addPathPatterns("/**").excludePathPatterns("/css/**", "/*.ico", "/error");
        registry.addInterceptor(new LoginCheckInterceptor())
                .order(2)
                .addPathPatterns("/**")
                .excludePathPatterns("/", "members/add", "/login", "/css/**", "logout", "/*.ico", "/error");
    }
}
```

`WebMvcConfigurer` ê°€ ì œê³µí•˜ëŠ” `addInterceptors()` ë¥¼ ì‚¬ìš©í•´ì„œ ì¸í„°ì…‰í„°ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆë‹¤.

- `registry.addInterceptor(new LogInterceptor())` : ì¸í„°ì…‰í„°ë¥¼ ë“±ë¡í•œë‹¤.
- `order(1)` : ì¸í„°ì…‰í„°ì˜ í˜¸ì¶œ ìˆœì„œë¥¼ ì§€ì •í•œë‹¤ - ë‚®ì„ ìˆ˜ë¡ ë¨¼ì € í˜¸ì¶œ ëœë‹¤.
- `addPathPatterns(â€/**â€)` : ì¸í„°ì…‰í„°ë¥¼ ì ìš©í•  URL íŒ¨í„´ì„ ì§€ì •í•œë‹¤.
- `excludePathPatterns(â€/css/**â€, â€œ/*.icoâ€, â€œ/errorâ€)` : ì¸í„°ì…‰í„°ì—ì„œ ì œì™¸í•  íŒ¨í„´ì„ ì§€ì •í•œë‹¤.

í•„í„°ì™€ ë¹„êµí•´ë³´ë©´, ì¸í„°ì…‰í„°ëŠ” `addPathPatterns, excludePathPatterns` ë¡œ ë§¤ìš° ì •ë°€í•˜ê²Œ URL íŒ¨í„´ì„ ì§€ì •í•  ìˆ˜ ìˆë‹¤.

## ìŠ¤í”„ë§ ì¸í„°ì…‰í„° - ì¸ì¦ ì²´í¬

ë¡œê·¸ì¸ ê²€ì¦ì€ í•´ë‹¹ ì»¨íŠ¸ë¡¤ëŸ¬ (í•¸ë“¤ëŸ¬ ì–´ëŒ‘í„°) ê°€ í˜¸ì¶œë˜ê¸° ì „ ê²€ì¦ì„ ì‹¤ì‹œí•˜ê³ , í•´ë‹¹ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ í˜¸ì¶œ ì—¬ë¶€ë¥¼ íŒë‹¨í•´ì•¼ í•œë‹¤. ì¦‰ ë¡œê·¸ì¸ ê²€ì¦ì—ì„œëŠ” `preHandle` ì´ ì‚¬ìš©ë˜ëŠ” ê²ƒì´ ë°”ëŒì§ í•˜ë‹¤.

**LoginCheckInterceptor**

```java
@Slf4j
public class LoginCheckInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        String requestURI = request.getRequestURI();
        log.info("ì¸ì¦ ì²´í¬ ì¸í„°ì…‰í„° ì‹¤í–‰ {}", requestURI);

        HttpSession session = request.getSession();

        if (session == null || session.getAttribute(SessionConst.LOGIN_MEMBER) == null) {
            log.info("ë¯¸ì¸ì¦ ì‚¬ìš©ì ìš”ì²­");
            response.sendRedirect("/login?redirectURL=" + requestURI);
            return false;
        }

        return true;
    }
}

```

## ArgumentResolver í™œìš©

**`@Login` ì• ë…¸í…Œì´ì…˜ì„ ì§ì ‘ ë§Œë“¤ì–´ ì‹¤í–‰í•˜ì!**

ì§ì ‘ ë§Œë“  ì• ë…¸í…Œì´ì…˜ì´ ìˆë‹¤ë©´, ì§ì ‘ ë§Œë“  `ArgumentResolver` ê°€ ë™ì‘í•´ì„œ ìë™ìœ¼ë¡œ ì„¸ì…˜ì— ìˆëŠ” ë¡œê·¸ì¸ íšŒì›ì„ ì°¾ì•„ì£¼ê³ , ë§Œì•½ ì„¸ì…˜ì´ ì—†ë‹¤ë©´ `null` ì„ ë°˜í™˜í•˜ë„ë¡ ê°œë°œí•˜ì.

**@Login Annotaion**

```java
@Target(ElementType.PARAMETER)
@Retention(RetentionPolicy.RUNTIME)
public @interface Login {

}
```

**LoginMemberArgumentResolver**

```java
@Slf4j
public class LoginMemberArgumentResolver implements HandlerMethodArgumentResolver {
    @Override
    public boolean supportsParameter(MethodParameter parameter) {
        log.info("supportsParameter ì‹¤í–‰");

        boolean hasLoginAnnotation = parameter.hasParameterAnnotation(Login.class);

        boolean hasMemberType = Member.class.isAssignableFrom(parameter.getParameterType());

        return hasLoginAnnotation && hasMemberType;
    }

    @Override
    public Object resolveArgument(MethodParameter methodParameter, ModelAndViewContainer modelAndViewContainer, NativeWebRequest nativeWebRequest, WebDataBinderFactory webDataBinderFactory) throws Exception {
        log.info("resolveArgument ì‹¤í–‰");

        HttpServletRequest nativeRequest = (HttpServletRequest) nativeWebRequest.getNativeRequest();
        HttpSession session = nativeRequest.getSession(false);
        if (session == null) {
            return null;
        }

        return session.getAttribute(SessionConst.LOGIN_MEMBER);
    }
}
```

- `supportsParameter()` : `@Login` ì• ë…¸í…Œì´ì…˜ì´ ìˆìœ¼ë©´ì„œ, `Member` íƒ€ì…ì´ë©°ëŠ í•´ë‹¹ `ArgumentResolver` ê°€ ì‚¬ìš©ëœë‹¤.
- `resolveArgument()` : ì»¨íŠ¸ë¡¤ëŸ¬ í˜¸ì¶œ ì§ì „ì— í˜¸ì¶œ ë˜ì–´ì„œ, í•„ìš”í•œ íŒŒë¼ë¯¸í„° ì •ë³´ë¥¼ ìƒì„±í•´ì¤€ë‹¤. ì—¬ê¸°ì„œëŠ” ì„¸ì…˜ì— ìˆëŠ” ë¡œê·¸ì¸ íšŒì› ì •ë³´ì¸ `member` ê°ì²´ë¥¼ ì°¾ì•„ì„œ ë°˜í™˜í•´ì¤€ë‹¤.

**HomeController**

```java
@GetMapping("/")
public String homeLoginArgumentResolver(@Login Member loginMember, Model model) {
    if (loginMember == null) {
        return "home";
    }
    model.addAttribute("member", loginMember);
    return "loginHome";
}
```

**WebConfig**

```java
@Override
public void addArgumentResolvers(List<HandlerMethodArgumentResolver> resolvers) {
    resolvers.add(new LoginMemberArgumentResolver());
}
```
