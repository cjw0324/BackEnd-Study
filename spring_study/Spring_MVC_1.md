# MVC 1편

## 매일 매일 기록하는 Study

### 24.10.03

Spring mvc : 실무에서 가장 많이 사용되는 자바 웹 프레임워크

spring mvc의 구조를 완벽히 이해하는 것이 중요하다!

모든 것이 HTTP 프로토콜 기반으로 통신을 한다 (데이터를 주고 받는다)

### 웹 서버 Web Server

- HTTP 프로토콜을 기반으로 동작
- 정적 리소스를 제공한다
    - 정적 리소스 : HTML, CSS, JS, 이미지 등

→ Nginx, Apache

### 웹 어플리케이션 서버 Web Application Server

- HTTP 프로토콜을 기반으로 동작
- 웹 서버 기능을 포함한다 → 정적 리소스를 제공하는 기능도 가지고 있음.
- 프로그램 코드를 실행하여 어플리케이션 로직을 수행한다
    - 동적 HTML. HTTP API(JSON)
    - 서블릿, JSP, 스프링 MVC

→ Tomcat, jetty, undertow

- 자바 언어 → 서블릿 컨테이너 기능을 제공하면 WAS.
- WAS는 어플리케이션 코드를 실행하는데 더 특화되어 있다.

## 서블릿?

WAS 서버를 직접 개발한다면, HTTP 통신에 필요한 모든 과정을 개발해야 한다. 이에 따른 부담이 증가한다.

예시) TCP/IP 소켓 통신을 위한 부분, HTTP 메시지를 파싱하는 부분, 내용 확인 및 HTTP 메시지 바디 파싱 등등.

### 해결 : 서블릿을 사용하는 WAS!

```jsx
@WebServlet(name = "helloServlet", urlPatterns = "/hello")
public class HelloServlet extends HttpServlet{
	@Override
	protected void service(HttpServletRequest request, HttpServletResponse response){
			//어플리케이션 비즈니스 로직
	}
}
```

→ urlPatterns (URL)이 호출되면 서블릿 코드가 실행된다.

→ 개발자는 HTTP 스펙을 매우 편리하게 사용할 수 있게 됨.

## 서블릿 컨테이너?

서블릿을 지원하는 WAS 안에는 서블릿 컨테이너가 있다.

서블릿 객체를 서블릿 컨테이너가 자동으로 생성, 호출, 관리 해준다.

- 톰캣처럼 서블릿을 지원하는 WAS를 서블릿 컨테이너라고 한다.
- **서블릿 객체는 싱글톤으로 관리한다**
    - 싱글톤? → 객체를 하나만 생성하고, 그것을 공유하며 (나의 jvm 안에서) 사용한다.
        
        → new 로 생성하지 않고 사용한다.
        
    - 그러기 위해 최초 로딩 시 객체를 만들고 이것을 재사용 한다.
    - 모든 고객의 HTTP 요청은 동일한 서블릿 객체 인스턴스에 접근함.
    - **따라서, 공유 변수 사용에 주의하여야 한다.**
- **동시 요청을 위한 멀티 쓰레드 처리를 지원한다.**
    
    → 개발자는 동시 요청에 대한 것에 큰 신경을 쓰지 않게 도와준다.
    

### 동시 요청 - 멀티 쓰레드 (Multi thread)

- 어플리케이션을 실행하는 것은 쓰레드
- 자바 메인 메서드를 처음 실행하면 main 쓰레드가 실행된다
- 쓰레드는 한번에 하나의 한줄의 코드만 수행한다
- **동시 처리가 필요하면, 쓰레드를 추가로 생성해야 한다.**

### 단, 요청마다 쓰레드를 생성한다면?

- 쓰레드는 생성 비용이 비싸다
- 쓰레드의 컨텍스트 스위칭 비용이 발생한다
- 쓰레드의 생성에 제한이 없다 → 고객 요청이 너무 많다면, CPU와 메모리 등 에서 임계점을 넘어 서버가 죽을 수 있다.

(톰캣의 기본 최대 쓰레드는 200개로 설정됨. 변경은 가능.)

### 해결법 : 쓰레드 풀

- 쓰레드 풀에 미리 제한된 수의 쓰레드를 만들어 놓고, client 요청이 올 시, 쓰레드 풀에서 쓰레드를 쓴다→ 해당 쓰레드는 servlet 객체를 사용한다.
- servlet 객체 사용이 완료되면, 쓰레드 풀에 사용한 쓰레드를 반납한다.

→ 만약, 모든 쓰레드풀의 쓰레드가 다 사용중이라면?

- 기다리는 요청은 거절하거나, 특정 숫자많큼만 대기하도록 설정할 수 있다.

- **쓰레드 풀의 장점**
1.  쓰레드가 미리 생성되어 있으므로, 쓰레드를 생성하고 종료하는 비용(CPU)이 절약되고, 응답 시간이 빠르다.
2. 생성 가능한 쓰레드의 최대치가 있으므로 너무 많은 요청이 들어와도 기존 요청은 안전하게 처리할 수 있다.

### 쓰레드 풀

실무 팁

- WAS의 주요 튜닝 포인트는 최대 쓰레드 수이다.
    - 너무 낮게(적게) 설정한다면?
        
        → 서버 리소스는 여유롭지만, client는 금방 응답이 지연된다.
        
        → aws 예시로는, cpu 사용률이 5%인데, 쓰레드 수를 낮게 설정하여 여러 인스턴스를 생성하고 그에따른 비용이 높아진다.
        
    - 너무 높게(많이) 설정한다면?
        
        → 동시요청이 너무 많다면, CPU, 메모리 리소스의 임계점 초과로 서버가 다운될 수 있다.
        
- 어떻게 쓰레드 풀의 적정 숫자를 정해야 하나?
    - 아파치 ab, nGrinder(네이버에서 개발)

## 핵심 : WAS의 멀티 쓰레드 지원

- 멀티 쓰레드에 대한 부분은 WAS가 처리
- 개발자가 멀티 쓰레드 관련 코드를 신경쓰지 않아도 된다.
- 개발자는 싱글 쓰레드를 프로그래밍 하듯 편리하게 소스코드를 개발하면 된다.
- 멀티 쓰레드 환경이므로, 싱글톤 객체 - (서블릿, 스프링 빈)는 주의하여 사용해야 한다.
    - 왜? 공유변수로 멤버변수가 공유되기 때문에 해당 내용에 주의 하여야 함.