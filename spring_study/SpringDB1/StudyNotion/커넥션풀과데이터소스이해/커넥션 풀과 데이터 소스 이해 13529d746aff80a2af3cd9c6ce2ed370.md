# ì»¤ë„¥ì…˜ í’€ê³¼ ë°ì´í„° ì†ŒìŠ¤ ì´í•´

- ì»¤ë„¥ì…˜ í’€ ì´í•´
- DataSource ì´í•´
- DataSource ì˜ˆì œ 1 - DriverManger
- DataSource ì˜ˆì œ 2 - ì»¤ë„¥ì…˜ í’€
- DataSource ì ìš©

## ì»¤ë„¥ì…˜ í’€ ì´í•´

![image.png](%E1%84%8F%E1%85%A5%E1%84%82%E1%85%A6%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%91%E1%85%AE%E1%86%AF%E1%84%80%E1%85%AA%20%E1%84%83%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A5%20%E1%84%89%E1%85%A9%E1%84%89%E1%85%B3%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff80a2af3cd9c6ce2ed370/image.png)

ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ì„ íšë“í•  ë•ŒëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë³µì¡í•œ ê³¼ì •ì„ ê±°ì¹œë‹¤

1. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì€ DB ë“œë¼ì´ë²„ë¥¼ í†µí•´ ì»¤ë„¥ì…˜ì„ ì¡°íšŒ
2. DB ë“œë¼ì´ë²„ëŠ” DB ì™€ TCP/IP ì»¤ë„¥ì…˜ì„ ì—°ê²°
3. DB ë“œë¼ì´ë²„ëŠ” TCP/IP ì»¤ë„¥ì…˜ì´ ì—°ê²°ë˜ë©´, ID,PWì™€ ë¶€ê°€ ì •ë³´ë¥¼ DBë¡œ ì „ë‹¬í•œë‹¤
4. DBëŠ” ID, PWë¥¼ í†µí•´ ë‚´ë¶€ ì¸ì¦ì„ ì™„ë£Œí•˜ê³ , ë‚´ë¶€ì— DB ì„¸ì…˜ì„ ìƒì„±í•œë‹¤.
5. DBëŠ” ì»¤ë„¥ì…˜ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆë‹¤ëŠ” ì‘ë‹µì„ ë³´ë‚¸ë‹¤
6. DB ë“œë¼ì´ë²„ëŠ” ì»¤ë„¥ì…˜ ê°ì²´ë¥¼ ìƒì„±í•´ì„œ í´ë¼ì´ì–¸íŠ¸ì— ë°˜í™˜í•œë‹¤.

â†’ ë¬¸ì œì ?

- ì»¤ë„¥ì…˜ì„ í•­ìƒ ìƒˆë¡œë§Œë“œëŠ” ê²ƒì€ ë³µì¡í•˜ê³ , ì‹œê°„ì´ ë§ì´ ì†Œëª¨ëœë‹¤.
- DB ì™€ DBë“œë¼ì´ë²„ (=ì• í”Œë¦¬ì¼€ì´ì…˜) ì—ì„œ ì»¤ë„¥ì…˜ì„ ìƒˆë¡œ ìƒì„±í•˜ê¸° ìœ„í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ë§¤ë²ˆ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
- ìœ ì €ê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ DB ì²˜ë¦¬ ìš”ì²­ì´ ë°œìƒí•˜ë©´ SQLë¬¸ì„ ì‹¤í–‰í•˜ëŠ” ì‹œê°„ + ì»¤ë„¥ì…˜ì„ ìƒˆë¡œ ë§Œë“œëŠ”ë° ë°œìƒí•˜ëŠ” ë¶€ê°€ì ì¸ ì‹œê°„ì´ ë°œìƒí•œë‹¤. ì¦‰ ì‘ë‹µ ì†ë„ê°€ ëŠë ¤ì§€ê³  ì´ëŠ” ì‚¬ìš©ì ê²½í—˜ì„ ì €í•´í•œë‹¤.

### ì»¤ë„¥ì…˜ í’€

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì»¤ë„¥ì…˜ë“¤ì„ ë¯¸ë¦¬ ë§Œë“¤ì–´ë‘ê³  ì‚¬ìš©í•˜ëŠ” ì»¤ë„¥ì…˜ í’€ì´ë¼ëŠ” ë°©ë²•ì´ë‹¤. ì»¤ë„¥ì…˜ í’€ì€ ì´ë¦„ ê·¸ë˜ë„ ì»¤ë„¥ì…˜ì„ ê´€ë¦¬í•˜ëŠ” í’€ ì´ë‹¤.

![image.png](%E1%84%8F%E1%85%A5%E1%84%82%E1%85%A6%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%91%E1%85%AE%E1%86%AF%E1%84%80%E1%85%AA%20%E1%84%83%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A5%20%E1%84%89%E1%85%A9%E1%84%89%E1%85%B3%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff80a2af3cd9c6ce2ed370/image%201.png)

- **ì»¤ë„¥ì…˜ í’€ ì‚¬ìš© ì˜ˆì‹œ 1**
    - ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì—ì„œ ì´ì œëŠ” DBë“œë¼ì´ë²„ë¥¼ í†µí•´ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ íšë“í•˜ì§€ ì•ŠëŠ”ë‹¤.
    - ì´ì œëŠ” ì»¤ë„¥ì…˜ í’€ì—ì„œ ì´ë¯¸ ìƒì„±ë˜ì–´ ìˆëŠ” ì»¤ë„¥ì…˜ì„ ê°ì²´ ì°¸ì¡°ë¡œ ê·¸ëƒ¥ ê°€ì ¸ë‹¤ ì‚¬ìš©í•˜ë©´ ëœë‹¤.
    - ì»¤ë„¥ì…˜ í’€ì— ì»¤ë„¥ì…˜ì„ ìš”ì²­í•˜ë©´, ì»¤ë„¥ì…˜ í’€ì€ ìì‹ ì´ ê°€ì§€ê³  ìˆëŠ” ì»¤ë„¥ì…˜ ì¤‘ì— í•˜ë‚˜ë¥¼ ë°˜í™˜í•œë‹¤.
- **ì»¤ë„¥ì…˜ í’€ ì‚¬ìš© ì˜ˆì‹œ 2**
    - ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì€ ì»¤ë„¥ì…˜ í’€ì—ì„œ ë°›ì€ ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•´ì„œ SQLì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì „ë‹¬í•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ë°›ì•„ì„œ ì²˜ë¦¬í•œë‹¤.
    - ì»¤ë„¥ì…˜ì„ ëª¨ë‘ ì‚¬ìš©í•˜ê³  ë‚˜ë©´, ì´ì œëŠ” ì»¤ë„¥ì…˜ì„ ì¢…ë£Œí•˜ì§€ ì•Šê³ , ë‹¤ìŒì— ë‹¤ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•´ë‹¹ ì»¤ë„¥ì…˜ì„ ê·¸ëŒ€ë¡œ ì»¤ë„¥ì…˜ í’€ì— ë°˜í™˜í•œë‹¤. ì¤‘ìš”í•œ ê²ƒì€ ì‚´ì•„ìˆëŠ” ìƒíƒœë¡œ ë°˜í™˜í•œë‹¤!

**ì»¤ë„¥ì…˜ í’€ ì˜¤í”ˆì†ŒìŠ¤**

- commons-dbcp2
- tomcat-jdbc pool
- **HikariCP**
    - ìŠ¤í”„ë§ë¶€íŠ¸ 2.0 ë¶€í„° ê¸°ë³¸ ì»¤ë„¥ì…˜ í’€ì„ hikariCPë¥¼ ì œê³µí•œë‹¤.

## DataSource ì´í•´

ì»¤ë„¥ì…˜ì„ ì´ì „ì˜ ì½”ë“œì²˜ëŸ¼ JDBC DriverManager ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì—¬ ì»¤ë„¥ì…˜ì„ ìƒì„±í•  ìˆ˜ ë„ ìˆê³ , HikariCP ì»¤ë„¥ì…˜ í’€ì—ì„œ ì»¤ë„¥ì…˜ì„ ë°›ì•„ ì‚¬ìš©í•  ìˆ˜ ë„ ìˆë‹¤.

ì´ë•Œ ê¸°ì¡´ì˜ ì½”ë“œë¡œëŠ” ì»¤ë„¥ì…˜ì„ íšë“í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œë„ ë³€ê²½ë˜ì–´ì•¼ í•œë‹¤. ì˜ì¡´ê´€ê³„ê°€ DriverManager â†’ HikariCP ë¡œ ë³€ê²½ë˜ì—ˆê¸° ë•Œë¬¸ì´ë‹¤. ë”°ë¼ì„œ ì»¤ë„¥ì…˜ì„ íšë“í•˜ëŠ” ë°©ë²•ì„ ì¶”ìƒí™” í•˜ì—¬ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

**ì»¤ë„¥ì…˜ì„ íšë“í•˜ëŠ” ë°©ë²•ì„ ì¶”ìƒí™” í•˜ê¸°**

![image.png](%E1%84%8F%E1%85%A5%E1%84%82%E1%85%A6%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%91%E1%85%AE%E1%86%AF%E1%84%80%E1%85%AA%20%E1%84%83%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A5%20%E1%84%89%E1%85%A9%E1%84%89%E1%85%B3%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff80a2af3cd9c6ce2ed370/image%202.png)

- ìë°”ì—ì„œëŠ” ì´ëŸ° ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ `jakarta.sql.DataSource` ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•œë‹¤.
- `DataSource` ëŠ” ì»¤ë„¥ì…˜ì„ íšë“í•˜ëŠ” ë°©ë²•ì„ ì¶”ìƒí™”í•œë‹¤.
- **ì´ ì¸í…Œí˜ì´ìŠ¤ì˜ í•µì‹¬ ê¸°ëŠ¥ì€ ì»¤ë„¥ì…˜ ì¡°íšŒ ì´ë‹¤.**

**DataSource - interface**

```java
public interface DataSource {
    Connection getConnection() throws SQLException;
}
```

**getConnection() ì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤!**

- ê¸°ì¡´ì˜ DriverManager ëŠ” DataSource ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤. ë”°ë¼ì„œ DriverManagerëŠ” ì§ì ‘ ì‚¬ìš©í•´ì•¼ í•œë‹¤. ë”°ë¼ì„œ DriverManagerë¥¼ ì‚¬ìš©í•˜ë‹¤ê°€ DataSource ê¸°ë°˜ì˜ ì»¤ë„¥ì…˜ í’€ì„ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½í•˜ë ¤ë©´, ê´€ë ¨ ì½”ë“œë¥¼ ë‹¤ ê³ ì³ì•¼ í•œë‹¤. ì´ëŸ° ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ìŠ¤í”„ë§ì€ DriverManager ë„ DataSource ë¥¼ í†µí•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ `DriverManagerDataSource` ë¼ëŠ” DataSource ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ë¥¼ ì œê³µí•œë‹¤.

ì¦‰, DriverManagerDataSource â†’ í•­ìƒ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ íšë“í•œë‹¤.

## DataSource ì˜ˆì œ 1 - DriverManager

```java
@Test
void dataSourceDriverManager() throws SQLException {
    DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);
    useDataSource(dataSource);
}

private void useDataSource(DataSource dataSource) throws SQLException {
    Connection con1 = dataSource.getConnection();
    Connection con2 = dataSource.getConnection();
    log.info("connection={}, class={}", con1, con1.getClass());
    log.info("connection={}, class={}", con2, con2.getClass());
}
```

**Code ì„¤ëª… :**

1. `DataManagerDataSource` â†’ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” dataSource 
2. `dataSource.getConnection();` â†’ dataSource (DataManagerDataSource) ì˜ ì»¤ë„¥ì…˜ì„ ë°›ì•„ì˜¨ë‹¤.
    
    `DataManagerDataSource` ì´ê¸° ë•Œë¬¸ì—, ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ ë°˜í™˜ ë°›ëŠ”ë‹¤.
    

## DataSource ì˜ˆì œ 2 - ì»¤ë„¥ì…˜ í’€

```java
@Test
void dataSourceConnectionPool() throws SQLException, InterruptedException {
    HikariDataSource dataSource = new HikariDataSource();
    dataSource.setJdbcUrl(URL);
    dataSource.setUsername(USERNAME);
    dataSource.setPassword(PASSWORD);
    dataSource.setMaximumPoolSize(10);
    dataSource.setPoolName("MyPool");

    useDataSource(dataSource);
    Thread.sleep(1000);
}

private void useDataSource(DataSource dataSource) throws SQLException {
    Connection con1 = dataSource.getConnection();
    Connection con2 = dataSource.getConnection();
    log.info("connection={}, class={}", con1, con1.getClass());
    log.info("connection={}, class={}", con2, con2.getClass());
}
```

- HikariCP ì»¤ë„¥ì…˜ í’€ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ `HikariDataSource dataSource = new HikariDataSource();` ë¥¼ ì‚¬ìš©í•œë‹¤.
- `HikariDataSource` ëŠ” Builder pattern ì´ ì ìš©ë˜ì–´ ìˆë‹¤. í•„ìš”í•œ ì„¤ì • ì •ë³´ë¥¼ set í•´ì£¼ê³  ì‚¬ìš©í•˜ë©´ ëœë‹¤.

## DataSource ì ìš©

ì• í”Œë¦¬ì¼€ì´ì…˜ì— DataSource ë¥¼ ì ìš©í•´ë³´ì.

**MemberRepositoryV1**

```java
package hello.jdbc.repository;

import hello.jdbc.domain.Member;
import lombok.extern.slf4j.Slf4j;
import org.springframework.jdbc.support.JdbcUtils;
import javax.sql.DataSource;
import java.sql.*;
import java.util.NoSuchElementException;

/**
 * JDBC - DataSource ì‚¬ìš©, Jdbc Utils ì‚¬ìš©
 */
@Slf4j
public class MemberRepositoryV1 {

    private final DataSource dataSource;

    public MemberRepositoryV1(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    public Member save(Member member) throws SQLException {
        String sql = "insert into member(member_id, money) values (?,?)";

        Connection connection = null;
        PreparedStatement preparedStatement = null;

        try {
            connection = getConnection();
            preparedStatement = connection.prepareStatement(sql);
            preparedStatement.setString(1, member.getMemberId());
            preparedStatement.setInt(2, member.getMoney());
            preparedStatement.executeUpdate();
            return member;
        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(connection, preparedStatement, null);
        }
    }

    public Member findById(String memberId) throws SQLException {
        String sql = "select * from member where member_id = ?";

        Connection connection = null;
        PreparedStatement preparedStatement = null;
        ResultSet resultSet = null;

        try {
            connection = getConnection();
            preparedStatement = connection.prepareStatement(sql);
            preparedStatement.setString(1, memberId);

            resultSet = preparedStatement.executeQuery();

            if (resultSet.next()) {
                Member member = new Member();
                member.setMemberId(resultSet.getString("member_id"));
                member.setMoney(resultSet.getInt("money"));
                return member;
            } else {
                throw new NoSuchElementException("member not found memberId = " + memberId);
            }

        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(connection, preparedStatement, resultSet);
        }
    }

    public void update(String memberId, int money) throws SQLException {
        String sql = "update member set money=? where member_id=?";

        Connection connection = null;
        PreparedStatement preparedStatement = null;

        try {
            connection = getConnection();
            preparedStatement = connection.prepareStatement(sql);
            preparedStatement.setInt(1, money);
            preparedStatement.setString(2, memberId);
            int resultSize = preparedStatement.executeUpdate();
            log.info("resultSize={}", resultSize);
        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(connection, preparedStatement, null);
        }
    }

    public void delete(String memberId) {
        String sql = "delete from member where member_id = ?";
        Connection connection = null;
        PreparedStatement preparedStatement = null;

        try{
            connection = getConnection();
            preparedStatement = connection.prepareStatement(sql);
            preparedStatement.setString(1, memberId);
            preparedStatement.executeUpdate();
            log.info("delete memberId={}", memberId);
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    }

    private void close(Connection connection, Statement statement, ResultSet resultSet) {
        JdbcUtils.closeResultSet(resultSet);
        JdbcUtils.closeStatement(statement);
        JdbcUtils.closeConnection(connection);
    }

    private Connection getConnection() throws SQLException {
        Connection connection = dataSource.getConnection();
        log.info("get connection ={}, class ={}", connection, connection.getClass());
        return connection;
    }
}

```

**ğŸ’¡ì¤‘ìš”Â Point**

- ìƒì„±ì ì£¼ì…ìœ¼ë¡œ dataSource ë¥¼ ë°›ê³ , ì´ë¥¼ getConnection() ë©”ì„œë“œì—ì„œ dataSource.getConnection ê²°ê³¼ ì»¤ë„¥ì…˜ì„ ë°˜í™˜í•˜ì—¬ ì´ë¥¼ ì‚¬ìš©í•œë‹¤.
- ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ V0 ê³¼ ë™ì¼í•˜ë‚˜, ì»¤ë„¥ì…˜ì„ ë‹«ëŠ” ê³¼ì •ì„ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í¸ì˜ ë©”ì„œë“œê°€ ì œê³µëœë‹¤.
    - `JdbcUtils` í¸ì˜ ë©”ì„œë“œ
        - ìŠ¤í”„ë§ì€ JDBC ë¥¼ í¸ë¦¬í•˜ê²Œ ë‹¤ë£° ìˆ˜ ìˆëŠ” JdbcUtils ë¼ëŠ” í¸ì˜ ë©”ì„œë“œë¥¼ ì œê³µí•œë‹¤.
        - JdbcUtilsì„ ì‚¬ìš©í•˜ë©´ ì»¤ë„¥ì…˜ì„ ì¢€ ë” í¸ë¦¬í•˜ê²Œ ë‹«ì„ ìˆ˜ ìˆë‹¤.

**Test**

```java
package hello.jdbc.repository;

import com.zaxxer.hikari.HikariDataSource;
import hello.jdbc.domain.Member;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import java.sql.SQLException;
import java.util.NoSuchElementException;
import static hello.jdbc.connection.ConnectionConst.*;
import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

@Slf4j
class MemberRepositoryV1Test {

    MemberRepositoryV1 repository;

    @BeforeEach
    void beforeEach() {
        //ê¸°ë³¸ DriverManager - í•­ìƒ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ íšë“

//        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);

        //ì»¤ë„¥ì…˜ í’€ë§
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl(URL);
        dataSource.setUsername(USERNAME);
        dataSource.setPassword(PASSWORD);

        repository = new MemberRepositoryV1(dataSource);
    }

    @Test
    void crud() throws SQLException {
        Member memberV0 = new Member("memberV100", 10000);
        repository.save(memberV0);

        //FindById
        Member findMember = repository.findById(memberV0.getMemberId());
        log.info("findMember = {}", findMember);

        log.info("member != findMember {}", memberV0 == findMember);
        assertThat(findMember).isEqualTo(memberV0);

        //update money 10000 -> 20000
        repository.update(memberV0.getMemberId(), 20000);
        Member updatedMember = repository.findById(memberV0.getMemberId());
        assertThat(updatedMember.getMoney()).isEqualTo(20000);

        //delete
        repository.delete(memberV0.getMemberId());

        //ë“±ë¡ í–ˆë‹¤ê°€ ë°”ë¡œ ì‚­ì œí•˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— ë³¼ ìˆ˜ ì—†ë‹¤.
        //ê·¸ëŸ¼ ê²€ì¦ì„ ì–´ë–»ê²Œ í•´ì•¼ í•˜ëŠ”ê°€?
        assertThatThrownBy(() -> repository.findById(memberV0.getMemberId())).isInstanceOf(NoSuchElementException.class);

    }
}
```

**ğŸ’¡ì¤‘ìš”Â Point**

ì• ë…¸í…Œì´ì…˜ â€œ`@beforeEach`â€ ë¡œ ê° í…ŒìŠ¤íŠ¸ê°€ ì‹œì‘ ì „ ì‹¤í–‰ë˜ë„ë¡ í•œë‹¤. ë¬´ì—‡ì„? ğŸ‘‡ğŸ»

1. ì»¤ë„¥ì…˜ í’€ ì„ ìƒì„±. â†’ HikariCP ë¥¼ í†µí•´ ìƒì„±í•œë‹¤.
`HikariDataSource dataSource = new HikariDataSource();`
2. repository ì¸ìŠ¤í„´ìŠ¤ ìƒì„±.