# íŠ¸ëœì­ì…˜ ì´í•´

- íŠ¸ëœì­ì…˜ - ê°œë… ì´í•´
- ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° êµ¬ì¡°ì™€ DB ì„¸ì…˜
- íŠ¸ëœì­ì…˜ - DB ì˜ˆì œ 1 - ê°œë… ì´í•´
- íŠ¸ëœì­ì…˜ - DB ì˜ˆì œ 2 - ìë™ ì»¤ë°‹, ìˆ˜ë™ ì»¤ë°‹
- íŠ¸ëœì­ì…˜ - DB ì˜ˆì œ 3 - íŠ¸ëœì­ì…˜ ì‹¤ìŠµ
- íŠ¸ëœì­ì…˜ - DB ì˜ˆì œ 4 - ê³„ì¢Œì´ì²´
- DB ë½ - ê°œë… ì´í•´
- DB ë½ - ë³€ê²½
- DB ë½ - ì¡°íšŒ
- íŠ¸ëœì­ì…˜ - ì ìš©1
- íŠ¸ëœì­ì…˜ - ì ìš©2

## íŠ¸ëœì­ì…˜ - ê°œë… ì´í•´

ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ í•˜ëŠ” ì´ìœ ê°€ ë¬´ì—‡ì¼ê¹Œ?

â†’ ë°ì´í„°ë² ì´ìŠ¤ëŠ” íŠ¸ëœì­ì…˜ì´ë¼ëŠ” ê°œë…ì„ ì§€ì›í•˜ê¸° ë•Œë¬¸!

íŠ¸ëœì­ì…˜? : ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ íŠ¸ëœì­ì…˜ì´ë€, í•˜ë‚˜ì˜ ê±°ë˜ë¥¼ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ë„ë¡ ë³´ì¥í•´ì£¼ëŠ” ê²ƒì„ ëœ»í•œë‹¤.

â†’ ì •ìƒ ì²˜ë¦¬ ì´í›„ : Commit

â†’ ë¹„ì •ìƒ ì²˜ë¦¬ ì´í›„ : Rollback

### íŠ¸ëœì­ì…˜ ACID

íŠ¸ëœì­ì…˜ ACID : 

- Atomicity : ì›ìì„±
- Consistency : ì¼ê´€ì„±
- Isolation : ê²©ë¦¬ì„±
- Durability : ì§€ì†ì„±

â†’ 4ê°€ì§€ë¥¼ íŠ¸ëœì­ì…˜ì—ì„œ ë³´ì¥í•´ì•¼ í•œë‹¤.

**íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ - Isolation level**

- READ UNCOMMITED - ì»¤ë°‹ë˜ì§€ ì•Šì€ ì½ê¸°
- READ COMMITED - ì»¤ë°‹ëœ ì½ê¸°
- REPEATABLE READ - ë°˜ë³µ ê°€ëŠ¥í•œ ì½ê¸°
- SERIALIZABLE - ì§ë ¬í™” ê°€ëŠ¥

ìœ„ë¡œ ê°ˆìˆ˜ë¡ ê²©ë¦¬ ìˆ˜ì¤€ì´ ë‚®ì•„ì§„ë‹¤. ê·¸ë§Œí¼ ì•ˆì „ì„±ì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆì§€ë§Œ, ì§ë ¬í™”ë¡œ ê°ˆìˆ˜ë¡ ì²˜ë¦¬ì†ë„ê°€ ëŠ¦ì–´ì§€ê³ , ì—¬ëŸ¬ ì œí•œì´ ë°œìƒí•œë‹¤. ëŒ€ë¶€ë¶„ì˜ ë°ì´í„°ë² ì´ìŠ¤ëŠ” â€œ READ COMMITED â€œ ìˆ˜ì¤€ì˜ ê²©ë¦¬ ìˆ˜ì¤€ì„ ë”°ë¥¸ë‹¤.

## ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° êµ¬ì¡°ì™€ DB ì„¸ì…˜

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image.png)

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%201.png)

- ì‚¬ìš©ìëŠ” ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ = WAS ë‚˜ DB ì ‘ê·¼ íˆ´ ë“±ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì„œë²„ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤. ì´ë•Œ í´ë¼ì´ì–¸íŠ¸ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì„œë²„ì— ì—°ê²°ì„ ìš”ì²­í•˜ê³  (TCP/IP) ì»¤ë„¥ì…˜ì„ ë§ºê²Œ ëœë‹¤. ê·¸ë¦¬ê³  DB ì„œë²„ ë‚´ë¶€ì— â€œì„¸ì…˜â€ ì´ë¼ëŠ” ê²ƒì„ ë§Œë“ ë‹¤. ê·¸ë¦¬ê³  ì•ìœ¼ë¡œ í•´ë‹¹ ì»¤ë„¥ì…˜ì— ëŒ€í•œ ìš”ì²­ì€ í•´ë‹¹ ì„¸ì…˜ì„ í†µí•´ì„œ ì‹¤í–‰ëœë‹¤.
- ë”°ë¼ì„œ ì»¤ë„¥ì…˜ì´ ìƒì„±ë  ë•Œ, í•´ë‹¹ ì»¤ë„¥ì…˜ì˜ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ì„¸ì…˜ì„ ë§Œë“ ë‹¤. ë”°ë¼ì„œ ì»¤ë„¥ì…˜ê³¼ ì„¸ì…˜ì€ ì¼ë°˜ì ìœ¼ë¡œ 1:1 ì´ë‹¤.
- ì´í›„ ì„¸ì…˜ì€ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³ , ì»¤ë°‹ ë˜ëŠ” ë¡¤ë°±ì„ í†µí•´ íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œí•œë‹¤. ê·¸ë¦¬ê³  ì´í›„ ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì„ ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆë‹¤.
- ì‚¬ìš©ìê°€ ì‚¬ìš©ì„ ë§ˆì¹˜ê³  ì»¤ë„¥ì…˜ì„ ë‹«ê±°ë‚˜, ë˜ëŠ” DBAê°€ ì„¸ì…˜ì„ ê°•ì œë¡œ ì¢…ë£Œí•˜ë©´, ì´ì œ ì„¸ì…˜ì´ ì¢…ë£Œëœë‹¤.

## íŠ¸ëœì­ì…˜  - DB ì˜ˆì œ 1 - ê°œë… ì´í•´

íŠ¸ëœì­ì…˜ ë™ì‘ì„ ì˜ˆì œë¥¼ í†µí•´ í™•ì¸í•´ë³´ì.

**íŠ¸ëœì­ì…˜ ì‚¬ìš©ë²•**

- ë°ì´í„° ë³€ê²½ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì— ê·¸ ê²°ê³¼ë¥¼ ë°˜ì˜í•˜ë ¤ë©´, ì»¤ë°‹ ëª…ë ¹ì–´ì¸ `commit;` ì„ í˜¸ì¶œí•˜ê³ , ê²°ê³¼ë¥¼ ë°˜ì˜í•˜ê³  ì‹¶ì§€ ì•Šë‹¤ë©´, ë¡¤ë°± ëª…ë ¹ì–´ì¸ `rollback;` ì„ í˜¸ì¶œí•˜ë©´ ëœë‹¤.
- ì»¤ë°‹ì„ í˜¸ì¶œí•˜ê¸° ì „ê¹Œì§€ëŠ” ì„ì‹œë¡œ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ê²ƒì´ë‹¤.
- ë”°ë¼ì„œ í•´ë‹¹ íŠ¸ëœì­ì…˜ìœ¼ ì‹œì‘í•œ ì„¸ì…˜ - ì‚¬ìš©ì ì—ê²Œë§Œ ë³€ê²½ ë°ì´í„°ê°€ ë³´ì´ê³  ë‹¤ë¥¸ ì„¸ì…˜ ì‚¬ìš©ìì—ê²ŒëŠ” ë³€ê²½ ë°ì´í„°ê°€ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤.
- ë“±ë¡, ìˆ˜ì •, ì‚­ì œ ëª¨ë‘ ê°™ì€ ì›ë¦¬ë¡œ ë™ì‘í•œë‹¤.

## íŠ¸ëœì­ì…˜ - DB ì˜ˆì œ 2 - ìë™ ì»¤ë°‹, ìˆ˜ë™ ì»¤ë°‹

**ì˜ˆì œì— ì‚¬ìš©ë˜ëŠ” ìŠ¤í‚¤ë§ˆ**

```sql
drop table member if exists;
  create table member (
      member_id varchar(10),
      money integer not null default 0,
      primary key (member_id)
);
```

**ìë™ ì»¤ë°‹ vs ìˆ˜ë™ ì»¤ë°‹**

íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € ìë™ ì»¤ë°‹ê³¼ ìˆ˜ë™ ì»¤ë°‹ì„ ì´í•´í•´ì•¼ í•œë‹¤.

**ìë™ ì»¤ë°‹?**

- ê°ê°ì˜ ì¿¼ë¦¬ë¬¸ ì‹¤í–‰ ì§í›„ì— ìë™ìœ¼ë¡œ ì»¤ë°‹ì„ í˜¸ì¶œí•œë‹¤. ë”°ë¼ì„œ ì»¤ë°‹ì´ë‚˜ ë¡¤ë°±ì„ ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•Šì•„ë„ ë˜ëŠ” í¸ë¦¬í•¨ì´ ìˆë‹¤.
- í•˜ì§€ë§Œ ì¿¼ë¦¬ë¥¼ í•˜ë‚˜í•˜ë‚˜ ì‹¤í–‰í•  ë•Œ ë§ˆë‹¤ ìë™ìœ¼ë¡œ ì»¤ë°‹ì´ ë˜ì–´ë²„ë¦¬ê¸° ë•Œë¬¸ì— ìš°ë¦¬ê°€ ì›í•˜ëŠ” íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ì œëŒ€ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.

**ìë™ ì»¤ë°‹ ì„¤ì •**

```sql
set autocommit true; //ìë™ ì»¤ë°‹ ëª¨ë“œ ì„¤ì •
insert into member(member_id, money) values ('data1',10000); //ìë™ ì»¤ë°‹ insert into member(member_id, money) values ('data2',10000); //ìë™ ì»¤ë°‹
```

ë”°ë¼ì„œ commit, rollback ì„ ì§ì ‘ í˜¸ì¶œí•˜ë©´ì„œ íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ì œëŒ€ë¡œ ìˆ˜í–‰í•˜ë ¤ë©´ ìë™ ì»¤ë°‹ì„ ë„ê³  ìˆ˜ë™ ì»¤ë°‹ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

**ìˆ˜ë™ ì»¤ë°‹ ì„¤ì •**

```sql
set autocommit false; //ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œ ì„¤ì •
insert into member(member_id, money) values ('data3',10000); insert into member(member_id, money) values ('data4',10000); commit; //ìˆ˜ë™ ì»¤ë°‹
```

ë³´í†µ ìë™ ì»¤ë°‹ ëª¨ë“œê°€ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •ëœ ê²½ìš°ê°€ ë§ê¸° ë•Œë¬¸ì—, ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì„ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œë‹¤ê³  í•  ìˆ˜ ìˆë‹¤.

## íŠ¸ëœì­ì…˜ - DB ì˜ˆì œ3 - íŠ¸ëœì­ì…˜ ì‹¤ìŠµ

### 1. ê¸°ë³¸ ë°ì´í„° ì…ë ¥

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%202.png)

**ë°ì´í„° ì´ˆê¸°í™” SQL**

```sql
//ë°ì´í„° ì´ˆê¸°í™”
set autocommit true;
delete from member;
insert into member(member_id, money) values ('oldId',10000);
```

### 2. ì‹ ê·œ ë°ì´í„° ì¶”ê°€ - ì»¤ë°‹ ì „

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%203.png)

**ì„¸ì…˜ 1ì—ì„œ ì‹ ê·œ ë°ì´í„° ì¶”ê°€ SQL**

```sql
//íŠ¸ëœì­ì…˜ ì‹œì‘
set autocommit false; //ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œ
insert into member(member_id, money) values ('newId1',10000); insert into member(member_id, money) values ('newId2',10000);
```

**ì‹¤í–‰ ê²°ê³¼**

**Session1**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%204.png)

**Session 1 ì—ì„œ ë°ì´í„° ì¡°íšŒ**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%205.png)

**Session 2**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%206.png)

ì„¸ì…˜1, 2 ì˜ ê²°ê³¼ ì´ë¯¸ì§€ë¥¼ ë¹„êµí•´ë³´ë©´, ì•„ì§ ì„¸ì…˜1 ì—ì„œ ì»¤ë°‹ì„ í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì—, ì„¸ì…˜1ì—ì„œëŠ” ì…ë ¥í•œ ë°ì´í„°ê°€ ë³´ì´ì§€ë§Œ ì„¸ì…˜2ì—ì„œëŠ” ì…ë ¥í•œ ë°ì´í„°ê°€ ë³´ì´ì§€ ì•ŠëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

### 3.1. ì»¤ë°‹ - commit

**ì„¸ì…˜1 ì‹ ê·œ ë°ì´í„° ì¶”ê°€ í›„ commit ì™„ë£Œ**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%207.png)

**ì„¸ì…˜1ì—ì„œ `commit;` ì‹¤í–‰**

ì´í›„ ì„¸ì…˜2 ì—ì„œ ë°ì´í„°ê°€ ë°˜ì˜ë˜ì–´ ì‹¤ì œ ë°ì´í„°ê°€ ì¡°íšŒ ë¨ì„ ì•Œ ìˆ˜ ìˆë‹¤.

### 3.2. ë¡¤ë°±  - rollback

**ë°ì´í„° ì´ˆê¸°í™”**

```sql
//ë°ì´í„° ì´ˆê¸°í™”
set autocommit true;
delete from member;
insert into member(member_id, money) values ('oldId',10000);
```

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%208.png)

**ì„¸ì…˜1 ì‹ ê·œ ë°ì´í„° ì¶”ê°€**

```sql
//íŠ¸ëœì­ì…˜ ì‹œì‘
set autocommit false; //ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œ
insert into member(member_id, money) values ('newId1',10000); insert into member(member_id, money) values ('newId2',10000);
```

 **DB ì¡°íšŒ**

```sql
SELECT * FROM MEMBER;
```

**ì„¸ì…˜1 ì¡°íšŒ ê²°ê³¼**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%209.png)

**ì„¸ì…˜2 ì¡°íšŒ ê²°ê³¼**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%2010.png)

ì„¸ì…˜1ì´ ì•„ì§ ì»¤ë°‹í•˜ì§€ ì•Šì€ ìƒíƒœì´ê¸° ë•Œë¬¸ì—, ì„¸ì…˜1ì—ì„œëŠ” ë°ì´í„°ê°€ ë³´ì´ì§€ë§Œ, ì„¸ì…˜2ì—ì„œëŠ” ì…ë ¥í•œ ë°ì´í„°ê°€ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤.

**ì„¸ì…˜1 ì‹ ê·œ ë°ì´í„° ì¶”ê°€ í›„ Rollback**

```sql
rollback;
```

**ì„¸ì…˜1, 2 DB ì¡°íšŒ**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%2011.png)

**ì„¸ì…˜1, 2 ëª¨ë‘ ìƒˆë¡œìš´ ë°ì´í„°ê°€ DBì— ë°˜ì˜ë˜ì§€ ì•Šì€ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.**

## íŠ¸ëœì­ì…˜ - DB ì˜ˆì œ 4 - ê³„ì¢Œì´ì²´

- ê³„ì¢Œì´ì²´ ì˜ˆì œë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ì´ ì–´ë–»ê²Œ ì‚¬ìš©ë˜ëŠ”ì§€ ì•Œì•„ë³´ì

**ê³„ì¢Œì´ì²´ 3ê°€ì§€ Case**

- ê³„ì¢Œì´ì²´ ì •ìƒ
- ê³„ì¢Œì´ì²´ ë¬¸ì œ ìƒí™© - ì»¤ë°‹
- ê³„ì¢Œì´ì²´ ë¬¸ì œ ìƒí™© - ë¡¤ë°±

### ê³„ì¢Œì´ì²´ ì •ìƒ

**ê¸°ë³¸ ë°ì´í„° ì…ë ¥**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%2012.png)

```sql
set autocommit true;
  delete from member;
  insert into member(member_id, money) values ('memberA',10000);
  insert into member(member_id, money) values ('memberB',10000);

```

**ê³„ì¢Œì´ì²´ ì‹¤í–‰**

```sql
set autocommit false;
  update member set money=10000 - 2000 where member_id = 'memberA';
  update member set money=10000 + 2000 where member_id = 'memberB';
```

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%2013.png)

**ê³„ì¢Œì´ì²´ ì‹¤í–‰ SQL - ì„±ê³µ**

**ì„¸ì…˜1**

```sql
commit;
```

**ì„¸ì…˜1,2 DB ì¡°íšŒ**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%2014.png)

**ì •ìƒ ë™ì‘ í•œê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.**

### ê³„ì¢Œì´ì²´ ë¬¸ì œ ìƒí™©

ê¸°ë³¸ ë°ì´í„° ì…ë ¥

```sql
set autocommit true;
delete from member;
insert into member(member_id, money) values ('memberA',10000);
insert into member(member_id, money) values ('memberB',10000);
```

**ê³„ì¢Œì´ì²´ ì‹¤í–‰**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%2015.png)

**ì‹¤í–‰ SQL - ì˜¤ë¥˜**

```sql
set autocommit false;
update member set money=10000 - 2000 where member_id = 'memberA'; //ì„±ê³µ
update member set money=10000 + 2000 where member_iddd = 'memberB'; //ì¿¼ë¦¬ ì˜ˆì™¸
```

3ë²ˆì§¸ ì¤„ â†’ member_iddd ë¡œ ì¸í•´ 3ë²ˆì§¸ì¤„ì€ ì¿¼ë¦¬ ì‹¤í–‰ì—ì„œ ì˜ˆì™¸ëœë‹¤.

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%2016.png)

**ì„¸ì…˜1 commit**

```sql
commit;
```

**ì„¸ì…˜1, 2 DB ì¡°íšŒ ê²°ê³¼**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%2017.png)

â†’ memberA ì˜ ëˆì€ 2000ì›ì´ ì‚¬ë¼ì¡Œê³ , memberB ì˜ ëˆì€ 2000ì› ì¦ê°€í•´ì•¼ í•˜ì§€ë§Œ, memberBì˜ ëˆì€ ê·¸ëŒ€ë¡œì´ë‹¤. ì¦‰ 2000ì›ì´ ì‚¬ë¼ì¡Œë‹¤!

### ê³„ì¢Œì´ì²´ ë¬¸ì œ ìƒí™© - ë¡¤ë°±

ë‹¤ì‹œ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ê¸°ë³¸ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì.

```sql
set autocommit true;
  delete from member;
  insert into member(member_id, money) values ('memberA',10000);
  insert into member(member_id, money) values ('memberB',10000);
```

**ê³„ì¢Œì´ì²´ ì‹¤í–‰ SQL - ì˜¤ë¥˜**

```sql
set autocommit false;
update member set money=10000 - 2000 where member_id = 'memberA'; //ì„±ê³µ
update member set money=10000 + 2000 where member_iddd = 'memberB'; //ì¿¼ë¦¬ ì˜ˆì™¸ ë°œìƒ
```

- ì—¬ê¸°ì„œ ë¬¸ì œëŠ” memberA ì˜ ëˆì€ 2000ì› ì¤„ì—ˆì§€ë§Œ, memberB ì˜ ëˆì€ 2000ì› ì¦ê°€í•˜ì§€ ì•Šì•˜ë‹¤.

**ì‹¤í–‰ ê²°ê³¼**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%2018.png)

**ë¡¤ë°±**

ì´ëŸ´ë•ŒëŠ” ë¡¤ë°±ì„ í˜¸ì¶œí•´ì„œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê¸° ì „ ë‹¨ê³„ë¡œ ë°ì´í„°ë¥¼ ë³µêµ¬í•´ì•¼ í•œë‹¤.

**ì„¸ì…˜1 ë¡¤ë°±**

```sql
rollback;
```

**ì„¸ì…˜1, 2 DB ì¡°íšŒ**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%2019.png)

**ì •ë¦¬**

ì›ìì„± : íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì‹¤í–‰í•œ ì‘ì—…ë“¤ì€ ë§ˆì¹˜ í•˜ë‚˜ì˜ ì‘ì—…ì¸ ê²ƒ ì²˜ëŸ¼ ëª¨ë‘ ì„±ê³µí•˜ê±°ë‚˜, ëª¨ë‘ ì‹¤íŒ¨í•´ì•¼ í•œë‹¤.

ì´ë¥¼ í†µí•´ ì—¬ëŸ¬ SQL ëª…ë ¹ì–´ë¥¼ ë§ˆì¹˜ í•˜ë‚˜ì˜ ì‘ì—…ì¸ ê²ƒ ì²˜ëŸ¼ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤. ì„±ê³µí•˜ë©´ í•œë²ˆì— ë°˜ì˜í•˜ê³ , ì¤‘ê°„ì— ì‹¤íŒ¨í•´ë„ í•˜ë‚˜ì˜ ì‘ì—… ì²˜ëŸ¼ ë˜ëŒë¦¬ëŠ” ê²ƒì´ í•„ìš”í•˜ë‹¤.

â†’ ì´ë¥¼ ìœ„í•´ íŠ¸ëœì­ì…˜ì„ ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œë¡œ ì‘ì—…í•´ì•¼ í•˜ê³ , ì‘ì—…ì˜ ì²˜ë¦¬ì— ë”°ë¼ ì„±ê³µ ì‹œ commit, ì‹¤íŒ¨ ì‹œ rollback í•´ì•¼ í•œë‹¤.

## DB ë½ - ê°œë… ì´í•´

ì„¸ì…˜1ì´ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³  ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ëŠ” ë™ì•ˆ ì•„ì§ ì»¤ë°‹ì„ ì§„í–‰í•˜ì§€ ì•Šì•˜ëŠ”ë°, ì„¸ì…˜2ì—ì„œ ë™ì‹œì— ê°™ì€ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ê²Œ ë˜ë©´ ì—¬ëŸ¬ ë¬¸ì œê°€ ë°œìƒí•œë‹¤. â†’ íŠ¸ëœì­ì…˜ì˜ ì›ìì„±ì´ ê¹¨ì§„ë‹¤.

ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì„¸ì…˜ì´ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³  ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ëŠ” ë™ì•ˆì—ëŠ” ì»¤ë°‹ì´ë‚˜ ë¡¤ë°± ì „ ê¹Œì§€ ë‹¤ë¥¸ ì„¸ì…˜ì—ì„œ í•´ë‹¹ ë°ì´í„°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ê²Œ ë§‰ì•„ì•¼ í•œë‹¤.

## DB ë½ - ë³€ê²½

**ì‹¤ìŠµ**

**ê¸°ë³¸ ë°ì´í„° ì…ë ¥ - SQL**

```sql
set autocommit true;
delete from member;
insert into member(member_id, money) values ('memberA',10000);
```

### ë³€ê²½ê³¼ ë½

**ì„¸ì…˜1**

```sql
set autocommit false;
update member set money=500 where member_id = 'memberA';
```

**ë½1 ì‹¤í–‰ ê³¼ì •**

1. íŠ¸ëœì­ì…˜ ì‹œì‘
2. lock íšë“
3. update 500

**ì„¸ì…˜2**

```sql
SET LOCK_TIMEOUT 60000;
set autocommit false;
update member set money=1000 where member_id = 'memberA';
```

- ì„¸ì…˜2ëŠ” memberAì˜ ë°ì´í„°ë¥¼ 1000ì›ìœ¼ë¡œ ìˆ˜ì •í•˜ë ¤ í•œë‹¤.
- ì„¸ì…˜1ì´ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•˜ê±°ë‚˜ ë¡¤ë°±í•´ì„œ ì¢…ë£Œí•˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ì•„ì§ ì„¸ì…˜1ì´ ë½ì„ ê°€ì§€ê³  ìˆë‹¤.
- ë”°ë¼ì„œ ì„¸ì…˜2ëŠ” ë½ì„ íšë“í•˜ì§€ ëª»í•˜ì˜€ê¸° ë•Œë¬¸ì— ë°ì´í„°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ê³ 
- ì„¸ì…˜1ì´ ë½ì„ ë°˜í™˜í•˜ì—¬ ì„¸ì…˜2ê°€ ë½ì„ íšë“ í•  ìˆ˜ ìˆì„ ë•Œ ê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ”ë°, ì´ ì‹œê°„ì˜ íƒ€ì„ì•„ì›ƒì„ 60ì´ˆë¡œ ì„¤ì •í•˜ì˜€ë‹¤.

**ì„¸ì…˜2 ê°€ 60ì´ˆ ë‚´ì— ë½ì„ íšë“í•˜ì§€ ëª»í•˜ê³  timeout ë°œìƒí•œ ê²°ê³¼**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%2020.png)

**ì„¸ì…˜1ì´ ë½ì„ ë°˜ë‚©í•˜ì—¬ ì„¸ì…˜2ì—ì„œ ì²˜ë¦¬ëœ ê²°ê³¼**

**ì„¸ì…˜1 - commit or rollback**

```sql
commit;
// ë˜ëŠ”,
//rollback;
```

**ì„¸ì…˜2ì—ì„œ ë½ì„ íšë“í•˜ì—¬ ë°ì´í„°ë¥¼ ë³€ê²½**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%2021.png)

**ì‹¤í–‰ ê²°ê³¼ - ì„¸ì…˜1,2 DB ì¡°íšŒ**

**ì„¸ì…˜2 ì—ì„œ commit**

```sql
commit;
```

**ì‹¤í–‰ ê²°ê³¼**

![image.png](%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%20%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%2013529d746aff8009a10fce1394220a0f/image%2022.png)

## DB ë½ - ì¡°íšŒ

ì¼ë°˜ì ì¸ ì¡°íšŒëŠ” ë½ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.

â†’ ê·¸ëŸ¼ì—ë„ ì¡°íšŒì— ë½ì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” case?

ì¡°íšŒí•œ ë°ì´í„°ë¡œ, ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ë§Œë“¤ì–´ì•¼ í•  ë•Œê°€ ê·¸ ì˜ˆì‹œë¡œ ë“¤ ìˆ˜ ìˆë‹¤.

**ì˜ˆì‹œ ìƒí™©**

ë§¤ì¥ pos ì˜ ì •ì‚° â†’ í•˜ë£¨ì˜ ë§¤ì¶œì„ ê³„ì‚°í•˜ì—¬ ì •ì‚°ì§‘ê³„í‘œë¥¼ ë§Œë“¤ì–´ì•¼ í•˜ëŠ”ë°, ì´ ê³¼ì • ì¤‘ì— ë§¤ì¶œì˜ ìˆ˜ì •ì´ ë°œìƒí•˜ë©´? â†’ ìƒˆë¡œìš´ ì •ì‚°ì§‘ê³„í‘œê°€ í‹€ë¦° ì •ë³´ê°€ ëœë‹¤. ë”°ë¼ì„œ í•´ë‹¹ í…Œì´ë¸” (db ë°ì´í„°) ë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒì´ ì•„ë‹˜ì—ë„ ì¡°íšŒì— ë½ì´ í•„ìš”í•œ ìƒí™©ì´ ëœë‹¤.

ì•ì„œ ë°ì´í„° ì„¤ì •ê³¼ ìˆ˜ì •ì€ ì•Œì•„ë´¤ìœ¼ë‹ˆ, ì–´ë–»ê²Œ ì¡°íšŒì— ë½ì„ ê±¸ ìˆ˜ ìˆëŠ”ì§€ì— ëŒ€í•œ ì½”ë“œë§Œ ì œì‹œí•œë‹¤~

**ì„¸ì…˜1 ì¡°íšŒ - ë½**

```sql
set autocommit false;
select * from member where member_id='memberA' for update;
```

- select for update êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ë©´ ì¡°íšŒë¥¼ í•˜ë©° ë™ì‹œì— ì„ íƒí•œ ë¡œìš°ì˜ ë½ë„ íšë“í•œë‹¤.

## íŠ¸ëœì­ì…˜ - ì ìš© 1

ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ DB íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•´ì„œ ê³„ì¢Œì´ì²´ ê°™ì´ ì¤‘ìš”í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì–´ë–»ê²Œ êµ¬í˜„í•˜ëŠ”ì§€ ì•Œì•„ë³´ì.

ë¨¼ì € íŠ¸ëœì­ì…˜ ì—†ì´ ë‹¨ìˆœí•œ ê³„ì¢Œì´ì²´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ êµ¬í˜„í•´ë³´ì.
**MemberService1**

```sql
package hello.jdbc.mycode.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV1;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

import java.sql.SQLException;

@Slf4j
@RequiredArgsConstructor
public class MemberServiceV1 {
    private final MemberRepositoryV1 memberRepository;

    public void accountTransfer(String fromId, String toId, int money) throws SQLException {
        Member fromMember = memberRepository.findById(fromId);

        Member toMember = memberRepository.findById(toId);

        memberRepository.update(fromId, fromMember.getMoney() - money);
        log.info("my log : from member ê°ì†Œ ");

        log.info("validation before");
        // -> ì˜¤ë¥˜ ë°œìƒ ì‹œí‚¬ ê²ƒì„.
        validation(toMember);
        log.info("validation after");
        // -> toMemberì˜ id ê°€ ex ì´ë©´ ì˜ˆì™¸ ë°œìƒë¨.

        memberRepository.update(toId, toMember.getMoney() + money);
        log.info("my log : to member ì¦ê°€ ");
    }

    public static void validation(Member toMember) {
        if (toMember.getMemberId().equals("ex")) {
            throw new IllegalStateException("ì´ì²´ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        }
    }

}
```

**MemberServiceV1Test**

```sql
package hello.jdbc.mycode.service;

import com.zaxxer.hikari.HikariDataSource;
import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV1;
import hello.jdbc.service.MemberServiceV1;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import java.sql.SQLException;

import static hello.jdbc.connection.ConnectionConst.*;
import static org.assertj.core.api.Assertions.*;

class MemberServiceV1Test {

    public static final String MEMBER_A = "memberA";
    public static final String MEMBER_B = "memberB";
    public static final String MEMBER_EX = "ex";

    private MemberRepositoryV1 memberRepository;
    private MemberServiceV1 memberService;

    @BeforeEach
    void before() {
        //ì»¤ë„¥ì…˜ í’€ë§
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl(URL);
        dataSource.setUsername(USERNAME);
        dataSource.setPassword(PASSWORD);

        memberRepository = new MemberRepositoryV1(dataSource);
        memberService = new MemberServiceV1(memberRepository);
    }

    @AfterEach
    void after() {
        memberRepository.delete(MEMBER_A);
        memberRepository.delete(MEMBER_B);
        memberRepository.delete(MEMBER_EX);
    }

    @Test
    @DisplayName("ì •ìƒ ì´ì²´")
    void accountTransfer() throws SQLException {

        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberB = new Member(MEMBER_B, 10000);

        memberRepository.save(memberA);
        memberRepository.save(memberB);

        //when

        assertThatCode(() -> memberService.accountTransfer(memberA.getMemberId(), memberB.getMemberId(), 2000)).doesNotThrowAnyException();

        //then

        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberB = memberRepository.findById(memberB.getMemberId());

        assertThat(findMemberA.getMoney()).isEqualTo(8000);
        assertThat(findMemberB.getMoney()).isEqualTo(12000);

    }

    @Test
    @DisplayName("ë¹„ì •ìƒ ì´ì²´")
    void accountTransferEx() throws SQLException {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberEx = new Member(MEMBER_EX, 10000);

        memberRepository.save(memberA);
        memberRepository.save(memberEx);

        //when

        assertThatThrownBy(() -> memberService.accountTransfer(memberA.getMemberId(), memberEx.getMemberId(), 2000)).isInstanceOf(IllegalStateException.class);

        //then

        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberEx = memberRepository.findById(memberEx.getMemberId());

        assertThat(findMemberA.getMoney()).isEqualTo(8000);
        assertThat(findMemberEx.getMoney()).isEqualTo(10000);
    }
}
```

â†’ MyCode : ì„±ê³µ ì‹œ assertThatCode ì‚¬ìš©í•˜ì—¬ ê²€ì¦.

**ì‹¤í–‰ ê³¼ì •**

- memberA â†’ memberEx ë¡œ 2000ì› ê³„ì¢Œ ì´ì²´ í•œë‹¤.
    - memberA ì˜ ê¸ˆì•¡ì´ 2000ì› ê°ì†Œí•œë‹¤
    - memberEx íšŒì›ì˜ IDëŠ” ex ì´ë¯€ë¡œ ì¤‘ê°„ì— ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤ â†’ ì´ ë¶€ë¶„ì´ ì¤‘ìš”!
- ê³„ì¢Œì´ì²´ëŠ” ì‹¤íŒ¨í•˜ê³ , memberAì˜ ëˆë§Œ 2000ì› ì¤„ì–´ë“ ë‹¤.

## íŠ¸ëœì­ì…˜ - ì ìš© 2

- ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ íŠ¸ëœì­ì…˜ì„ ì–´ë–¤ ê³„ì¸µì— ê±¸ì–´ì•¼ í• ê¹Œ?, íŠ¸ëœì­ì…˜ì„ ì–´ë””ì„œ ì‹œì‘í•˜ê³  ì–´ë””ì„œ ì»¤ë°‹í•´ì•¼ í•˜ë‚˜?
- â†’ íŠ¸ëœì­ì…˜ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ìˆëŠ” ê³³. ì¦‰ ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ì‹œì‘í•´ì•¼ í•œë‹¤.
- ê·¸ëŸ°ë° íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ë ¤ë©´ ì»¤ë„¥ì…˜ì´ í•„ìš”í•˜ë‹¤.
- ê·¸ëŸ¬ë©´ ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ì»¤ë„¥ì…˜ì„ ë§Œë“¤ê³  íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì´í›„ì— ì»¤ë„¥ì…˜ì„ ì¢…ë£Œí•´ì•¼ í•œë‹¤.

â†’ ê°™ì€ ì»¤ë„¥ì…˜ì„ ìœ ì§€í•˜ë ¤ë©´, ì»¤ë„¥ì…˜ì„ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•´ì„œ ê°™ì€ ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•˜ë„ë¡ í•˜ì.

```sql
package hello.jdbc.repository;

import hello.jdbc.domain.Member;
import lombok.extern.slf4j.Slf4j;
import org.springframework.jdbc.support.JdbcUtils;

import javax.sql.DataSource;
import java.sql.*;
import java.util.NoSuchElementException;

/**
 * JDBC - ConnectionParam
 */
@Slf4j
public class MemberRepositoryV2 {

    private final DataSource dataSource;

    public MemberRepositoryV2(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    public Member save(Member member) throws SQLException {
        String sql = "insert into member(member_id, money) values (?,?)";

        Connection connection = null;
        PreparedStatement preparedStatement = null;

        try {
            connection = getConnection();
            preparedStatement = connection.prepareStatement(sql);
            preparedStatement.setString(1, member.getMemberId());
            preparedStatement.setInt(2, member.getMoney());
            preparedStatement.executeUpdate();
            return member;
        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(connection, preparedStatement, null);
        }
    }

    public Member findById(String memberId) throws SQLException {
        String sql = "select * from member where member_id = ?";

        Connection connection = null;
        PreparedStatement preparedStatement = null;
        ResultSet resultSet = null;

        try {
            connection = getConnection();
            preparedStatement = connection.prepareStatement(sql);
            preparedStatement.setString(1, memberId);

            resultSet = preparedStatement.executeQuery();

            if (resultSet.next()) {
                Member member = new Member();
                member.setMemberId(resultSet.getString("member_id"));
                member.setMoney(resultSet.getInt("money"));
                return member;
            } else {
                throw new NoSuchElementException("member not found memberId = " + memberId);
            }

        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(connection, preparedStatement, resultSet);
        }
    }

    public Member findById(Connection con, String memberId) throws SQLException {
        String sql = "select * from member where member_id = ?";

        PreparedStatement preparedStatement = null;
        ResultSet resultSet = null;

        try {

            preparedStatement = con.prepareStatement(sql);
            preparedStatement.setString(1, memberId);

            resultSet = preparedStatement.executeQuery();

            if (resultSet.next()) {
                Member member = new Member();
                member.setMemberId(resultSet.getString("member_id"));
                member.setMoney(resultSet.getInt("money"));
                return member;
            } else {
                throw new NoSuchElementException("member not found memberId = " + memberId);
            }

        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            JdbcUtils.closeResultSet(resultSet);
            JdbcUtils.closeStatement(preparedStatement);
            // ì»¤ë„¥ì…˜ì€ ì—¬ê¸°ì„œ ë‹«ì§€ ì•ŠëŠ”ë‹¤!
        }
    }

    public void update(String memberId, int money) throws SQLException {
        String sql = "update member set money=? where member_id=?";

        Connection connection = null;
        PreparedStatement preparedStatement = null;

        try {
            connection = getConnection();
            preparedStatement = connection.prepareStatement(sql);
            preparedStatement.setInt(1, money);
            preparedStatement.setString(2, memberId);
            int resultSize = preparedStatement.executeUpdate();
            log.info("resultSize={}", resultSize);
        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            close(connection, preparedStatement, null);
        }
    }

    public void update(Connection con, String memberId, int money) throws SQLException {
        String sql = "update member set money=? where member_id=?";

        PreparedStatement preparedStatement = null;

        try {
            preparedStatement = con.prepareStatement(sql);
            preparedStatement.setInt(1, money);
            preparedStatement.setString(2, memberId);
            int resultSize = preparedStatement.executeUpdate();
            log.info("resultSize={}", resultSize);
        } catch (SQLException e) {
            log.error("db error", e);
            throw e;
        } finally {
            JdbcUtils.closeStatement(preparedStatement);
            // ì»¤ë„¥ì…˜ì€ ì—¬ê¸°ì„œ ë‹«ì§€ ì•ŠëŠ”ë‹¤!
        }
    }

    public void delete(String memberId) {
        String sql = "delete from member where member_id = ?";
        Connection connection = null;
        PreparedStatement preparedStatement = null;

        try{
            connection = getConnection();
            preparedStatement = connection.prepareStatement(sql);
            preparedStatement.setString(1, memberId);
            preparedStatement.executeUpdate();
            log.info("delete memberId={}", memberId);
        } catch (SQLException e) {
            throw new RuntimeException(e);
        } finally {
            close(connection, preparedStatement, null);
        }
    }

    private void close(Connection connection, Statement statement, ResultSet resultSet) {
        JdbcUtils.closeResultSet(resultSet);
        JdbcUtils.closeStatement(statement);
        JdbcUtils.closeConnection(connection);
    }

    private Connection getConnection() throws SQLException {
        Connection connection = dataSource.getConnection();
        log.info("get connection ={}, class ={}", connection, connection.getClass());
        return connection;
    }
}

```

â†’ Repository ì—ì„œ ì»¤ë„¥ì…˜ ìœ ì§€ê°€ í•„ìš”í•œ ê³³?

: findById, update

```java
findById(Connection con, String memberId)
update(Connection con, String memberId, int money)
```

**MemberService2**

```java
package hello.jdbc.service;

import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV2;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.SQLException;

/**
 * íŠ¸ëœì­ì…˜ - íŒŒë¼ë¯¸í„° ì—°ë™, í’€ì„ ê³ ë ¤í•œ ì¢…ë£Œ.
 */

@Slf4j
@RequiredArgsConstructor
public class MemberServiceV2 {
    private final DataSource dataSource;
    private final MemberRepositoryV2 memberRepository;

    public void accountTransfer(String fromId, String toId, int money) throws SQLException {
        Connection con = dataSource.getConnection();

        try {
            con.setAutoCommit(false);
            //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰
            bizLogic(con, fromId, toId, money);
            con.commit();

        } catch (Exception e) {
            con.rollback();
            throw new IllegalStateException(e);
        } finally {
            release(con);
        }
    }

    private void bizLogic(Connection con, String fromId, String toId, int money) throws SQLException {
        Member fromMember = memberRepository.findById(con, fromId);
        Member toMember = memberRepository.findById(con, toId);

        memberRepository.update(con, fromId, fromMember.getMoney() - money);
        validation(toMember);
        memberRepository.update(con, toId, toMember.getMoney() + money);
    }

    private static void release(Connection con) {
        if (con != null) {
            try {
                con.setAutoCommit(true);
                con.close();
            } catch (Exception e) {
                log.info("error", e);
            }
        }
    }

    private static void validation(Member toMember) {
        if (toMember.getMemberId().equals("ex")) {
            throw new IllegalStateException("ì´ì²´ ì¤‘ ì˜ˆì™¸ ë°œìƒ");
        }
    }
}

```

- Connection con = dataSource.getConnection();
    - íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ë ¤ë©´ ì»¤ë„¥ì…˜ì´ í•„ìš”í•˜ë‹¤
- con.setAutoCommit(false);
    - íŠ¸ëœì­ì…˜ ì‹œì‘ â†’ ìë™ ì»¤ë°‹ ëª¨ë“œ ë„ê¸°
- bizLogic(con, fromId, toId, money);
    - íŠ¸ëœì­ì…˜ì´ ì‹œì‘ëœ ì»¤ë„¥ì…˜ì„ ì „ë‹¬í•˜ë©´ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìˆ˜í–‰í•œë‹¤.
- con.commit();
    - ì„±ê³µ ì‹œ ì»¤ë°‹
- con.rollback();
    - ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
- release(con)
    - finally ë¥¼ ì‚¬ìš©í•´ì„œ ì»¤ë„¥ì…˜ì„ ëª¨ë‘ ì‚¬ìš© í›„ ì¢…ë£Œí•œë‹¤. ê·¸ëŸ¬ë‚˜ ì»¤ë„¥ì…˜ í’€ì„ ì‚¬ìš©í•˜ë©´ con.close() ë¥¼ í˜¸ì¶œ í–ˆì„ ë•Œ ì»¤ë„¥ì…˜ì´ ì¢…ë£Œë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ í’€ì— ë°˜ë‚©ëœë‹¤.
    - í’€ì— ë°˜ë‚© ì „ ê¸°ë³¸ ê°’ì´ ìë™ ì»¤ë°‹ ëª¨ë“œë¡œ ë³€ê²½ í›„ ë°˜ë‚©.

**MemberServiceV2TEST**

```java
package hello.jdbc.service;

import com.zaxxer.hikari.HikariDataSource;
import hello.jdbc.domain.Member;
import hello.jdbc.repository.MemberRepositoryV1;
import hello.jdbc.repository.MemberRepositoryV2;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.jdbc.datasource.DriverManagerDataSource;

import java.sql.SQLException;

import static hello.jdbc.connection.ConnectionConst.*;
import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.junit.jupiter.api.Assertions.*;

/**
 * íŠ¸ëœì­ì…˜ - ì»¤ë„¥ì…˜ íŒŒë¼ë¯¸í„° ì „ë‹¬ ë°©ì‹ ë™ê¸°í™”
 */

@Slf4j
class MemberServiceV2Test {

    private MemberRepositoryV2 memberRepository;
    private MemberServiceV2 memberService;

    public static final String MEMBER_A = "memberA";
    public static final String MEMBER_B = "memberB";
    public static final String MEMBER_EX = "ex";

    @BeforeEach
    void before() {
        //ì»¤ë„¥ì…˜ í’€ë§
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl(URL);
        dataSource.setUsername(USERNAME);
        dataSource.setPassword(PASSWORD);
        memberRepository = new MemberRepositoryV2(dataSource);
        memberService = new MemberServiceV2(dataSource, memberRepository);
    }

    @AfterEach
    void after() {
        memberRepository.delete(MEMBER_A);
        memberRepository.delete(MEMBER_B);
        memberRepository.delete(MEMBER_EX);
    }

    @Test
    @DisplayName("ì •ìƒ ì´ì²´")
    void accountTransfer() throws SQLException {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberB = new Member(MEMBER_B, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberB);

        //when
        log.info("START TX");
        memberService.accountTransfer(memberA.getMemberId(), memberB.getMemberId(), 2000);
        log.info("END TX");

        //then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberB = memberRepository.findById(memberB.getMemberId());

        assertThat(findMemberA.getMoney()).isEqualTo(8000);
        assertThat(findMemberB.getMoney()).isEqualTo(12000);

    }

    @Test
    @DisplayName("ë¹„ì •ìƒ ì´ì²´ - ì´ì²´ ì¤‘ ì˜ˆì™¸ ë°œìƒ")
    void accountTransferEx() throws SQLException {
        //given
        Member memberA = new Member(MEMBER_A, 10000);
        Member memberEx = new Member(MEMBER_EX, 10000);
        memberRepository.save(memberA);
        memberRepository.save(memberEx);

        //when

        assertThatThrownBy(() -> memberService.accountTransfer(memberA.getMemberId(), memberEx.getMemberId(), 2000)).isInstanceOf(IllegalStateException.class);

        //then
        Member findMemberA = memberRepository.findById(memberA.getMemberId());
        Member findMemberEx = memberRepository.findById(memberEx.getMemberId());

        assertThat(findMemberA.getMoney()).isEqualTo(10000);
        assertThat(findMemberEx.getMoney()).isEqualTo(10000);

    }
}
```

**ì´ì²´ ì¤‘ ì˜ˆì™¸ ë°œìƒ case**

- ë°ì´í„° ì €ì¥ ë° í…ŒìŠ¤íŠ¸ ì¤€ë¹„
    - memberA - 10000
    - memberEx - 10000
- ê³„ì¢Œ ì´ì²´ ë¡œì§ ì‹¤í–‰
    - memberService.accountTransfer() ì‹¤í–‰
    - ì»¤ë„¥ì…˜ ìƒì„± í›„ íŠ¸ëœì­ì…˜ ì‹œì‘
    - memberA â†’ memberEx ë¡œ 2000ì› ê³„ì¢Œì´ì²´
        - memberA  ê¸ˆì•¡ 2000ì› ê°ì†Œ â†’ 8000
        - memberEx â†’ ì˜ˆì™¸ ë°œìƒ
    - **ì˜ˆì™¸ ë°œìƒ í›„ íŠ¸ëœì­ì…˜ ë¡¤ë°±!**
- ê³„ì¢Œì´ì²´ ì‹¤íŒ¨. ë¡¤ë°± í›„ memberA ëˆì´ ê¸°ì¡´ 10000 ìœ¼ë¡œ ë³µêµ¬ ë¨.

**â†’ íŠ¸ëœì­ì…˜ ì ìš©ìœ¼ë¡œ ì¸í•´ ê³„ì¢Œì´ì²´ê°€ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±ì„ í†µí•´ ëª¨ë“  ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ ì´ˆê¸°í™” ë¨!**

ğŸš¨**ë‚¨ì€ ë¬¸ì œ!**

ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ DB íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ë ¤ë©´ ì„œë¹„ìŠ¤ ê³„ì¸µì´ ì§€ì €ë¶„í•´ì§€ê³  ë³µì¡í•œ ì½”ë“œê°€ í•„ìš”í•˜ë‹¤. ë˜í•œ ì»¤ë„¥ì…˜ì„ ìœ ì§€í•˜ë„ë¡ ì½”ë“œë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒë„ ì‰½ì§€ ì•Šë‹¤. â†’ ***ì´ë¥¼ ìŠ¤í”„ë§ì„ ì‚¬ìš©í•´ í•´ê²°í•´ ë³´ì!***